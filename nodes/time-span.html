<script type="text/x-red" data-template-name="time-span">
  <div class="form-row">
    <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="time-span.label.position"></span></label>
    <input type="text" id="node-input-positionConfig">
    <input type="hidden" id="node-input-outputs"/>
  </div>
  <hr>
  <div class="form-row block-noindent time-operand1">
      <label for="node-input-operand1"><i class="fa fa-ellipsis-h"></i> <span data-i18n="time-span.label.operand1"></span></label>
      <input type="text" id="node-input-operand1">
      <input type="hidden" id="node-input-operand1Type">
  </div>
  <div class="form-row block-indent1 time-row-operand1Format hidden">
      <label for="node-input-operand1Formatsel"><i class="fa fa-sign-in"></i> <span data-i18n="time-span.label.operand1Format"></span></label>
      <select id="node-input-operand1Formatsel" >
      <input type="text" id="node-input-operand1Format" style="margin-left: 5px;"></input>
  </div>
  <div class="form-row block-indent1 time-row-operand1Offset hidden">
      <label for="node-input-operand1Offset"><i class="fa fa-calculator"></i> <span data-i18n="time-span.label.operand1Offset"></span></label>
      <input id="node-input-operand1Offset" data-i18n="[placeholder]time-span.placeholder.offset"></input>
      <input type="hidden" id="node-input-operand1OffsetType">
      <select id="node-input-operand1OffsetMultiplier" class="node-input-multiplier"></select>
  </div>
  <hr>
  <div class="form-row block-noindent time-operand2">
      <label for="node-input-operand2"><i class="fa fa-ellipsis-h"></i> <span data-i18n="time-span.label.operand2"></span></label>
      <input type="text" id="node-input-operand2">
      <input type="hidden" id="node-input-operand2Type"></input>
  </div>
  <div class="form-row block-indent1 time-row-operand2Format hidden">
      <label for="node-input-operand2Formatsel"><i class="fa fa-sign-in"></i> <span data-i18n="time-span.label.operand2Format"></span></label>
      <select id="node-input-operand2Formatsel">
      <input type="text" id="node-input-operand2Format" style="margin-left: 5px;"></input>
  </div>
  <div class="form-row block-indent1 time-row-operand2Offset hidden">
      <label for="node-input-operand2Offset"><i class="fa fa-calculator"></i> <span data-i18n="time-span.label.operand2Offset"></span></label>
      <input id="node-input-operand2Offset" data-i18n="[placeholder]time-span.placeholder.offset">
      <input type="hidden" id="node-input-operand2OffsetType">
      <select id="node-input-operand2OffsetMultiplier" class="node-input-multiplier"></select>
  </div>
  <hr>
  <div>
    <label for="node-input-rule-container-row"><i class="fa fa-list"></i> <span data-i18n="time-span.label.operatorContainer"></span></label>
    <div class="form-row node-input-rule-container-row">
      <ol id="node-input-rule-container"></ol>
    </div>
  </div>
  <div class="form-row">
      <select id="node-input-checkall" style="width:100%; margin-right:5px;">
          <option value="false" data-i18n="time-span.label.stopfirst"></option>
          <option value="true" data-i18n="time-span.label.checkall"></option>
      </select>
  </div>
  <hr>
  <div class="form-row block-noindent time-result1">
      <label for="node-input-result1"><i class="fa fa-terminal"></i> <span data-i18n="time-span.label.result1"></span></label>
      <input type="text" id="node-input-result1" class="row-full-width">
      <input type="hidden" id="node-input-result1Type">
  </div>
  <div class="form-row block-indent1 time-result1Value hidden">
      <label for="node-input-result1Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-span.label.result1Value"></span></label>
      <input type="text" id="node-input-result1Value" class="row-full-width">
      <input type="hidden" id="node-input-result1ValueType">
  </div>
  <div class="form-row block-indent2 time-row-result1TSFormat hidden">
    <label for="node-input-result1TSFormatSel"><i class="fa fa-sign-out"></i> <span data-i18n="time-span.label.result1TSFormat"></span></label>
    <select id="node-input-result1TSFormatSel">
    </select>
    <input type="text" id="node-input-result1TSFormat" class="form-row time-input-result1TSFormat hidden" style="margin-left: 5px;">
</div>
  <div class="form-row block-indent2 time-row-result1Format hidden">
      <label for="node-input-result1FormatSel"><i class="fa fa-sign-out"></i> <span data-i18n="time-span.label.result1Format"></span></label>
      <select id="node-input-result1FormatSel">
      </select>
      <input type="text" id="node-input-result1Format" style="margin-left: 5px;">
  </div>
  <div class="form-row block-indent2 time-row-result1Offset hidden">
      <label for="node-input-result1Offset"><i class="fa fa-calculator"></i> <span data-i18n="time-span.label.result1Offset"></span></label>
      <input id="node-input-result1Offset" data-i18n="[placeholder]time-span.placeholder.offset">
      <input type="hidden" id="node-input-result1OffsetType">
      <select id="node-input-result1OffsetMultiplier" class="node-input-multiplier">
      </select>
  </div>
  <hr>
  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="time-span.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]time-span.placeholder.name">
  </div>
</script>
<style>
    hr {
        width: 100%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 100%
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 100%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .node-input-rule-operator {
        width: 60px;
        margin-left: 5px;
        text-align: center;
    }
    .node-input-rule-operand {
        margin-left: 5px;
    }
    .node-input-rule-multiplier {
        width: 125px;
        margin-left: 5px;
    }
    .node-input-multiplier {
        width: 125px;
        margin-left: 5px;
    }
</style>
<script type="text/x-red" data-help-name="time-comp"> <p>A enhanced node for time format change and time comparision.</p>
    <h3>Input</h3>
        <p>When a message arrives through the Input a timestamp out of the message objet or a global or flow context store could be parsed into a timestamp.</p>
    <h3>Outputs</h3>
        <p>Outputs the Input message, where the posibility exists to change a property of the input message (or a global/flow context). If a time conversation is done the input message would be output to the according output where the timestamp is matching.</p>
  <h3>References</h3>
  Enhanced documentation can be found in the following locations:
  <ul>
      <li><a href="https://github.com/HM-RedMatic/node-red-contrib-sun-position">GitHub</a> - the nodes github repository</li>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">Node-Red</a> - the Node-Red Node overview</li>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">NPM</a> - the nodes npm node description</li>
  </ul>
  With friendly support by <b>agag</b>.
</script>
<script type="text/javascript">
    function clipValueLength(v, l) {
        if (v.length > l) {
            return v.substring(0, l - 3) + '...';
        }

        return v;
    }

    function getValueLabel(t, v, l) {
        l = l || 15;
        if (t === 'string' || t === 'str') {
            if (v === '') { return v; }
            return '"' + clipValueLength(v, l) + '"';
        }

        if (t === 'num' || t === 'bool') {
            if (v === '') { return v; }
            return String(v);
        }

        if (t === 'msg') {
            return t + '.' + clipValueLength(v, l);
        }
        if (t === 'msgPayload') {
            return 'msg.payload';
        }
        if (t === 'msgTs') {
            return 'msg.ts';
        }

        if (t === 'flow' || t === 'global') {
            const result = RED.utils.parseContextKey(v);
            return t + '.' + clipValueLength(result.key, l);
        }
        if (t === 'timespan') {
            return 'timespan';
        }
        if (t === 'operand1') {
            return 'operand1 data';
        }
        if (t === 'operand2') {
            return 'operand2 data';
        }

        if (t === 'pdsCalcData') {
            return '{sun position}';
        }

        if (t === 'pdmCalcData') {
            return '{moon position}';
        }

        if (t === 'pdsTime') {
            const res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('civil', '').replace('amateur', 'amat-').replace('blueHour', 'blHr-').replace('goldenHour', 'goHr-');
            return clipValueLength(res, l);
        }

        if (t === 'pdmTime') {
            return 'moon' + v;
        }

        return clipValueLength(v, l);
    }

    RED.nodes.registerType('time-span', {
        category: 'time and astro',
        color: '#EDFDBF',
        icon: 'time-span-black.png',
        inputs: 1,
        outputs: 1,
        defaults: {
            outputs: {
                value: 1
            },
            name: {
                value: '',
                required: false
            },
            positionConfig: {
                value: '',
                type: 'position-config',
                required: true
            },
            // #region operand1
            operand1: {
                value: 'payload',
                validate: RED.validators.typedInput('operand1Type')
            },
            operand1Type: {
                value: 'msgPayload'
            },
            operand1Format: {
                value: 0,
                required: true,
                validate: (v) => {
                    return (v !== '') || typeof v === 'undefined';
                }
            },
            operand1Offset: {
                value: 0,
                required: true,
                validate: (v) => {
                    return RED.validators.typedInput('operand1OffsetType')(v) || $('#node-input-operand1OffsetType').typedInput('type') === 'none' || this.operand1OffsetType === 'none';
                }
            },
            operand1OffsetType: {
                value: 'none'
            },
            operand1OffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) || $('#node-input-operand1OffsetType').typedInput('type') === 'none' || this.operand1OffsetType === 'none';
                }
            },
            // #endregion operand1
            // #region operand2
            operand2: {
                value: '',
                validate: RED.validators.typedInput('operand2Type')
            },
            operand2Type: {
                value: 'msg'
            },
            operand2Format: {
                value: 0,
                required: true,
                validate: (v) => {
                    return (v !== '') || typeof v === 'undefined';
                }
            },
            operand2Offset: {
                value: 0,
                required: true,
                validate: (v) => {
                    return RED.validators.typedInput('operand2OffsetType')(v) || $('#node-input-operand2OffsetType').typedInput('type') === 'none' || this.operand2OffsetType === 'none';
                }
            },
            operand2OffsetType: {
                value: 'none'
            },
            operand2OffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) || $('#node-input-operand2OffsetType').typedInput('type') === 'none' || this.operand2OffsetType === 'none';
                }
            },
            // #endregion operand2
            // #region rules
            rules: {
                value: [{
                    operator: 1,
                    operatorText: '==',
                    operandType: 'num',
                    operandValue: '',
                    multiplier: 60000
                }]
            },
            checkall: {
                value: 'true',
                required: true
            },
            // #endregion rules
            // #region result1
            result1: {
                value: 'payload',
                validate: RED.validators.typedInput('result1Type')
            },
            result1Type: {
                value: 'msgPayload'
            },
            result1Value: {
                value: '',
                validate: (v) => {
                    return (RED.validators.typedInput('result1ValueType')(v) || $('#node-input-result1').typedInput('type') === 'none' || this.result1Type === 'undefined');
                }
            },
            result1ValueType: {
                value: 'timespan'
            },
            result1TSFormat: {
                value: 1,
                required: false,
                validate: (v) => {
                    return ((v !== '') || $('#node-input-result1').typedInput('type') === 'none' || this.result1Type === 'undefined');
                }
            },
            result1Format: {
                value: 0,
                required: false,
                validate: (v) => {
                    return ((v !== '') || $('#node-input-result1').typedInput('type') === 'none' || this.result1Type === 'undefined');
                }
            },
            result1Offset: {
                value: 0,
                required: true,
                validate: (v) => {
                    return RED.validators.typedInput('result1OffsetType')(v) || $('#node-input-result1OffsetType').typedInput('type') === 'none' || this.result1OffsetType === 'none';
                }
            },
            result1OffsetType: {
                value: 'none'
            },
            result1OffsetMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) || $('#node-input-result1OffsetType').typedInput('type') === 'none' || this.result1OffsetType === 'none';
                }
            }
            // #endregion result1
        },
        outputLabels(index) {
            if (this.rules.length) {
                const rule = this.rules[index];
                if (rule) {
                    return rule.operatorText + ' ' + getValueLabel(rule.operandType, rule.operandValue);
                }
                if (this.checkall === 'true') {
                    return 'always';
                }
                return 'otherwise';
                // return ["msg if comparision is true", "msg if comparision is false"];
            }

            return 'input msg after evaluation';
        },
        label() {
            if (this.name) {
                return this.name;
            }
            if (!this.rules || this.rules.length <= 1) {
                const op1 = getValueLabel(this.operand1Type, this.operand1);
                const op2 = getValueLabel(this.operand2Type, this.operand2);
                return op1 + ' - ' + op2;
            } else if (this.rules && this.rules.length === 1) {
                const op1 = getValueLabel(this.operand1Type, this.operand1);
                const op2 = getValueLabel(this.operand2Type, this.operand2);
                const cmp = getValueLabel(this.rules[0].operandType, this.rules[0].operandValue);
                return op1 + ' - ' + op2 + ' ' + this.rules[0].operatorText + ' ' + cmp;
            } else if (this.rules && this.rules.length > 1) {
                const op1 = getValueLabel(this.operand1Type, this.operand1);
                const op2 = getValueLabel(this.operand2Type, this.operand2);
                return op1 + ' - ' + op2 + ' ' + this._('time-span.label.compare');
            }
            return this._('time-span.label.time-span');
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'time span',
        align: 'left',
        oneditprepare() {
            const node = this;
            const setup = function(node) {
                /* global getOperator getMultiplier getTypes appendOptions setupTInput initCombobox */
                const types = getTypes();
                // #region operand1
                setupTInput(node, {
                    typeProp: 'operand1Type',
                    valueProp: 'operand1',
                    width: 'calc(100% - 110px)',
                    defaultType: types.MsgPayload.value,
                    types: [types.MsgPayload, types.MsgTs, 'msg', 'flow', 'global', 'date', 'str', 'num', types.DateEntered, types.TimeSun, types.TimeMoon, types.DayOfMonth, 'env'],
                    onChange: (_type, _value) => {
                        const opType = $('#node-input-operand1').typedInput('type');
                        if (opType === 'date' ||
                            opType === types.TimeEntered.value ||
                            opType === types.DateEntered.value ||
                            opType === types.TimeSun.value ||
                            opType === types.TimeMoon.value ||
                            opType === types.DayOfMonth) {
                            $('.time-row-operand1Format').hide();
                            $('.time-row-operand1Offset').show();
                        } else if (opType === 'msg' ||
                                    opType === types.MsgPayload.value ||
                                    opType === types.MsgTs.value ||
                                    opType === 'flow' ||
                                    opType === 'global' ||
                                    opType === 'str' ||
                                    opType === 'num' ||
                                    opType === 'env') {
                            $('.time-row-operand1Format').show();
                            $('.time-row-operand1Offset').show();
                        } else {
                            $('.time-row-operand1Format').hide();
                            $('.time-row-operand1Offset').hide();
                        }
                    }
                }).change();

                initCombobox(node, 'time-span', 'operand1Formatsel', 'operand1Format', 'dateParseFormat', 'parseFormats', node.operand1Format, 20);

                const operand1MultiplierField = $('#node-input-operand1OffsetMultiplier');
                appendOptions(node, 'time-span', operand1MultiplierField, 'multiplier');
                operand1MultiplierField.val(node.operand1OffsetMultiplier);
                setupTInput(node, {
                    typeProp: 'operand1OffsetType',
                    valueProp: 'operand1Offset',
                    width: 'calc(100% - 255px)',
                    defaultType: types.Undefined.value,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-operand1Offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-operand1OffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-operand1OffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion operand1
                // #region operand2
                setupTInput(node, {
                    typeProp: 'operand2Type',
                    valueProp: 'operand2',
                    width: 'calc(100% - 110px)',
                    defaultType: types.MsgPayload.value,
                    types: [types.MsgPayload, types.MsgTs, 'msg', 'flow', 'global', 'date', 'str', 'num', types.DateEntered, types.TimeSun, types.TimeMoon, types.DayOfMonth, 'env'],
                    onChange: (_type, _value) => {
                        const opType = $('#node-input-operand2').typedInput('type');
                        if (opType === 'date' ||
                            opType === types.TimeEntered.value ||
                            opType === types.DateEntered.value ||
                            opType === types.TimeSun.value ||
                            opType === types.TimeMoon.value ||
                            opType === types.DayOfMonth) {
                            $('.time-row-operand2Format').hide();
                            $('.time-row-operand2Offset').show();
                        } else if (opType === 'msg' ||
                                    opType === types.MsgPayload.value ||
                                    opType === types.MsgTs.value ||
                                    opType === 'flow' ||
                                    opType === 'global' ||
                                    opType === 'str' ||
                                    opType === 'num' ||
                                    opType === 'env') {
                            $('.time-row-operand2Format').show();
                            $('.time-row-operand2Offset').show();
                        } else {
                            $('.time-row-operand2Format').hide();
                            $('.time-row-operand2Offset').hide();
                        }
                    }
                }).change();

                initCombobox(node, 'time-span', 'operand2Formatsel', 'operand2Format', 'dateParseFormat', 'parseFormats', node.operand1Format, 20);

                const operand2MultiplierField = $('#node-input-operand2OffsetMultiplier');
                appendOptions(node, 'time-span', operand2MultiplierField, 'multiplier');
                operand2MultiplierField.val(node.operand2OffsetMultiplier);
                setupTInput(node, {
                    typeProp: 'operand2OffsetType',
                    valueProp: 'operand2Offset',
                    width: 'calc(100% - 255px)',
                    defaultType: types.Undefined.value,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-operand2Offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-operand2OffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-operand2OffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion operand2
                // #region rule-container
                function resizeRule(rule) {
                    const newWidth = rule.width() - 10;
                    // const operatorField = rule.find('.node-input-rule-operator');
                    const operandField = rule.find('.node-input-rule-operand');
                    const multipierField = rule.find('.node-input-rule-multipier');
                    const lblWidth = 25;
                    // row1
                    const operatorWidth = 60;
                    const multiplierWidth = 125;
                    multipierField.width(multiplierWidth);
                    operandField.typedInput('width', (newWidth - operatorWidth - multiplierWidth- lblWidth - 20));
                }

                function resizeContainer() {
                    const editorRow = $('.node-input-rule-container-row ol');
                    const height =  editorRow.outerHeight(true);

                    const rows = $('#node-input-rule-container').editableList('items');
                    if (rows.size() > 0) {
                        $('#node-input-rule-container').editableList('height', height + 40);
                    } else {
                        $('#node-input-rule-container').editableList('height', 20);
                    }
                }

                $('#node-input-rule-container').css('min-height', '20px').css('min-width', '200px').editableList({
                    addItem(containerRow, containerIndex, data) {
                        containerRow.css({overflow: 'hidden', whiteSpace: 'nowrap'});
                        const row = $('<div/>').appendTo(containerRow);
                        // row1
                        // operator
                        const operatorField = $('<select/>', {
                            class: 'node-input-rule-operator',
                            id: 'node-input-rule-operator' + containerIndex
                        }).appendTo(row);
                        appendOptions(node, 'time-span', operatorField, 'operators');

                        const operandField = $('<input/>', {
                            class: 'node-input-rule-operand',
                            id: 'node-input-rule-operand' + containerIndex,
                            type: 'text'
                        }).appendTo(row).typedInput({
                            default: 'num',
                            types: ['msg', 'flow', 'global', 'num', 'env', 'jsonata']
                        });
                        const multiplierField = $('<select/>', {
                            class: 'node-input-rule-multiplier',
                            id: 'node-input-rule-multiplier' + containerIndex
                        }).appendTo(row);
                        appendOptions(node, 'time-span', multiplierField, 'multiplier', (id) => (id > 0) );
                        const finalspan = $('<span/>', {
                            style: 'float: right; margin-top: 6px;'
                        }).appendTo(row);
                        finalspan.append(' &#8594; <span class="node-input-rule-index">' + (containerIndex + 1) + '</span> ');
                        // setting defaultValues
                        // console.log(data);
                        operatorField.val(data.operator || getOperator(0).id);
                        operandField.typedInput('type', data.operandType || 'num');
                        operandField.typedInput('value', data.operandValue || '');
                        multiplierField.val(data.multiplier || getMultiplier(0).id);
                        resizeRule(containerRow);
                        resizeContainer();
                    },
                    sortItems(rules) {
                        rules = $('#node-input-rule-container').editableList('items');
                        rules.each(function (i) {
                            $(this).find('.node-input-rule-index').html(i + 1);
                        });
                    },
                    resizeItem: resizeRule,
                    sortable: true,
                    removable: true,
                    removeItem: resizeContainer
                });
                if (node.rules) {
                    for (let i = 0; i < node.rules.length; i++) {
                        const rule = node.rules[i];
                        $('#node-input-rule-container').editableList('addItem', rule);
                    }
                }
                // #endregion rule-container
                // #region result1
                setupTInput(node, {
                    typeProp: 'result1Type',
                    valueProp: 'result1',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    types: [types.Undefined, types.MsgPayload, types.MsgTs, 'msg', 'flow', 'global'],
                    onChange: (_type, _value) => {
                        console.log('node-input-result1 change ' + $('#node-input-result1').typedInput('type')); // eslint-disable-line
                        if ($('#node-input-result1').typedInput('type') !== types.Undefined.value) {
                            $('.time-result1Value').show();
                            const plVType = $('#node-input-result1Value').typedInput('type');
                            console.log('plVType= ' + plVType); // eslint-disable-line

                            if (plVType === types.TimeEntered.value || plVType === types.TimeSun.value || plVType === types.TimeMoon.value || plVType === 'date' || plVType === types.DateEntered.value) {
                                $('.time-row-result1Offset').show();
                                $('.time-row-result1TSFormat').hide();
                                $('.time-row-result1Format').show();
                            } else if (plVType === 'timespan') {
                                $('.time-row-result1Offset').hide();
                                $('.time-row-result1Format').hide();
                                $('.time-row-result1TSFormat').show();
                            } else if (plVType === 'operand1' || plVType === 'operand2') {
                                $('.time-row-result1Offset').hide();
                                $('.time-row-result1TSFormat').hide();
                                $('.time-row-result1Format').show();
                            } else {
                                $('.time-row-result1Offset').hide();
                                $('.time-row-result1TSFormat').hide();
                                $('.time-row-result1Format').hide();
                            }
                        } else {
                            $('.time-result1Value').hide();
                            $('.time-row-result1Offset').hide();
                            $('.time-row-result1TSFormat').hide();
                            $('.time-row-result1Format').hide();
                        }
                        $('#time-row-result1FormatSel').change(); // show '.time-row-result1Format'
                        $('#time-row-result1TSFormatSel').change(); // show '.time-row-result1Format'
                    }
                });

                setupTInput(node, {
                    typeProp: 'result1ValueType',
                    valueProp: 'result1Value',
                    width: 'calc(100% - 120px)',
                    defaultType: 'timespan',
                    types: [
                        {value: 'timespan', label: 'timespan between Inputs', hasValue: false},
                        {value: 'operand1', label: 'Input 1 value', hasValue: false},
                        {value: 'operand2', label: 'Input 2 value', hasValue: false},
                        'date',
                        types.TimeEntered,
                        types.DateEntered,
                        types.TimeSun,
                        types.TimeMoon,
                        'flow',
                        'global',
                        'str',
                        'num',
                        'bool',
                        'json',
                        'bin',
                        'env',
                        'jsonata',
                        types.SunCalc,
                        types.MoonCalc
                    ],
                    onChange: (_type, _value) => { $('#node-input-result1').change(); }
                }).change();
                /********************************************************/
                initCombobox(node, 'time-span', 'result1TSFormatSel', 'result1TSFormat', 'dateOutTSFormat', 'outputTSFormats', node.result1TSFormat, 30);
                /********************************************************/
                initCombobox(node, 'time-span', 'result1FormatSel', 'result1Format', 'dateOutFormat', 'outputFormats', node.result1Format, 30);
                /********************************************************/
                const resultMultiplierField = $('#node-input-result1OffsetMultiplier');
                appendOptions(node, 'time-span', resultMultiplierField, 'multiplier');
                resultMultiplierField.val(node.result1OffsetMultiplier);
                setupTInput(node, {
                    typeProp: 'result1OffsetType',
                    valueProp: 'result1Offset',
                    width: 'calc(100% - 265px)',
                    defaultType: types.Undefined.value,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-result1Offset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-result1OffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-result1OffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // autocomplete($('#node-input-result1TSFormat'), 'dateOutTSFormat');
                // autocomplete($('#node-input-result1Format'), 'dateOutFormat');
                // #endregion result1
                // #region spinner
                $('.wg-offset-spinner').spinner({max: 1439,min: -1439});
                // #endregion spinner
            }; // setup

            $.getScript('sun-position/js/htmlglobal.js')
                .done((_data, _textStatus, _jqxhr) => {
                    // console.log( _data ); // Data returned
                    setup(node);
                })
                .fail((jqxhr, settings, exception) => {
                    console.log("failed to load htmlglobal.js"); // eslint-disable-line
                    console.log(exception); // eslint-disable-line
                    console.log(exception.stack); // eslint-disable-line
                });
        },
        oneditsave() {
            const node = this;
            if (Number($('#node-input-operand1Formatsel').val()) !== 99) {
                $('#node-input-operand1Format').val($('#node-input-operand1Formatsel').val());
                node.operand1Format = $('#node-input-operand1Formatsel').val();
            }
            if (Number($('#node-input-operand2Formatsel').val()) !== 99) {
                $('#node-input-operand2Format').val($('#node-input-operand2Formatsel').val());
                node.operand2Format = $('#node-input-operand2Formatsel').val();
            }
            // #region rule-container
            node.rules = [];
            const rules = $('#node-input-rule-container').editableList('items');
            rules.each(function (_i) {
                const rule = $(this);
                const data = {
                    operator: rule.find('.node-input-rule-operator').val(),
                    operatorText: rule.find('.node-input-rule-operator option:selected').text(),
                    operandType: rule.find('.node-input-rule-operand').typedInput('type'),
                    operandValue: rule.find('.node-input-rule-operand').typedInput('value'),
                    multiplier: rule.find('.node-input-rule-multipier').val()
                };
                node.rules.push(data);
            });
            // console.log(this.rules);
            const outputs = (node.rules) ? (node.rules.length + 1) : 1;
            $('#node-input-outputs').val(outputs);
            // #endregion result-container
            // console.log(outputs);

            if (Number($('#node-input-result1FormatSel').val()) !== 99) {
                $('#node-input-result1Format').val($('#node-input-result1FormatSel').val());
                node.result1Format = $('#node-input-result1FormatSel').val();
            }

            node.operand1Type = $('#node-input-operand1').typedInput('type');
            node.operand2Type = $('#node-input-operand2').typedInput('type');
            node.result1Type = $('#node-input-result1').typedInput('type');
            node.result1ValueType = $('#node-input-result1Value').typedInput('type');
            node.result2Type = $('#node-input-result2').typedInput('type');
            node.result2ValueType = $('#node-input-result2Value').typedInput('type');
        // console.log($("#node-input-outputs").val());
        }
    });</script>
