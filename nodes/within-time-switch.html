<script type="text/x-red" data-template-name="within-time-switch">

    <div class="form-row">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="within-time-switch.label.position"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-input-startTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTime"></span></label>
        <input type="text" id="node-input-startTime" style="width: 70%"/>
    </div>
    <div class="form-row">
            <label for="node-input-startOffset"><i class="fa fa-arrows-h"></i> <span data-i18n="within-time-switch.label.startOffset"></span></label>
            <input id="node-input-startOffset"" class="wt-offset-time" data-i18n="[placeholder]within-time-switch.placeholder.startOffset">
    </div>
    <div class="form-row">
            <label for="node-input-endTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTime"></span></label>
            <input type="text" id="node-input-endTime" style="width: 70%"/>
    </div>
    <div class="form-row">
            <label for="node-input-endOffset"><i class="fa fa-arrows-h"></i> <span data-i18n="within-time-switch.label.endOffset"></span></label>
            <input id="node-input-endOffset" class="wt-offset-time" data-i18n="[placeholder]within-time-switch.placeholder.endOffset">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-input-addTimes"><i class="fa fa-share-alt"></i> &nbsp;</label>
        <input type="checkbox" id="node-input-addTimes" style="display:inline-block; width:15px; vertical-align:baseline;" />
        <span data-i18n="within-time-switch.label.addTimes"></span>
    </div>
    <div class="form-tips add-times-row hidden">
        <span data-i18n="within-time-switch.tips.addTimes"></span>&nbsp;
    </div>
    <div class="form-tips add-times-row hidden"/>
    <div class="form-row add-times-row hidden">
        <label ><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.property"></span></label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>
    <div class="form-row add-times-row hidden">
        <label for="node-input-startTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTimeAlt"></span></label>
        <input type="text" id="node-input-startTimeAlt" style="width: 70%"/>
    </div>
    <div class="form-row add-times-row hidden">
            <label for="node-input-startOffsetAlt"><i class="fa fa-arrows-h"></i> <span data-i18n="within-time-switch.label.startOffsetAlt"></span></label>
            <input id="node-input-startOffsetAlt"" class="wt-offset-time" data-i18n="[placeholder]within-time-switch.placeholder.startOffset">
    </div>
    <div class="form-row add-times-row hidden">
            <label for="node-input-endTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTimeAlt"></span></label>
            <input type="text" id="node-input-endTimeAlt" style="width: 70%"/>
    </div>
    <div class="form-row add-times-row hidden">
            <label for="node-input-endOffsetAlt"><i class="fa fa-arrows-h"></i> <span data-i18n="within-time-switch.label.endOffsetAlt"></span></label>
            <input id="node-input-endOffsetAlt"" class="wt-offset-time" data-i18n="[placeholder]within-time-switch.placeholder.endOffset">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="within-time-switch.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]within-time-switch.placeholder.name">
    </div>
</script>

<!-- Finally, the node type is registered along with all of its properties   -->
<!-- The example below shows a small subset of the properties that can be set-->
<script type="text/javascript">
    RED.nodes.registerType('within-time-switch', {
        category: 'function',
        color: '#f37a33',
        defaults: {
            name: {
                value: "",
                required: false
            },
            positionConfig: {
                value: "",
                type: "position-config",
                required: true
            },
            startTime: {
                value: "",
                required: true,
                validate: RED.validators.typedInput("startTimeType")
            },
            startTimeType: {
                value: "entered"
            },
            startOffset: {
                value: 0,
                required: true,
                validate: RED.validators.number()
            },
            endTime: {
                value: "",
                required: true,
                validate: RED.validators.typedInput("endTimeType")
            },
            endTimeType: {
                value: "entered"
            },
            endOffset: {
                value: 0,
                required: true,
                validate: RED.validators.number()
            },
            addTimes: {
                value: false,
                required: true,
                validate: function (v) {
                    return (v === true || v === false)
                }
            },
            property: {
                value: "",
                required: false,
                validate: function (v) {
                    return RED.validators.typedInput("propertyType")(v) || !$("#node-input-addTimes").is(
                        ':checked');
                }
            },
            propertyType: {
                value: "global"
            },
            startTimeAlt: {
                value: '',
                required: false,
                validate: function (v) {
                    return RED.validators.typedInput("startTimeAltType")(v) || !$("#node-input-addTimes").is(
                        ':checked');
                }
            },
            startTimeAltType: {
                value: "entered"
            },
            startOffsetAlt: {
                value: 0,
                required: true,
                validate: function (v) {
                    return RED.validators.number()(v) || !$("#node-input-addTimes").is(':checked');
                }
            },
            endTimeAlt: {
                value: '',
                required: false,
                validate: function (v) {
                    return RED.validators.typedInput("endTimeAltType")(v) || !$("#node-input-addTimes").is(
                        ':checked');
                }
            },
            endTimeAltType: {
                value: "entered"
            },
            endOffsetAlt: {
                value: 0,
                required: true,
                validate: function (v) {
                    return RED.validators.number()(v) || !$("#node-input-addTimes").is(':checked');
                }
            }
        },
        icon: 'switch.png',
        inputs: 1,
        outputs: 2,
        outputLabels: ["within time", "outside time"],
        label: function () {
            const getId = (type, value) => {
                if (type === 'msg' || type === 'flow' || type === 'global') {
                    return type + '.' + value;
                } else if (type === 'pdmTime') {
                    return 'moon ' + value;
                }
                return value;
            }
            const getConcatId = (type1, value1, type2, value2) => {
                if (value2) {
                    return getId(type1, value1) + '/' + getId(type2, value2);
                }
                return getId(type1, value1);
            }

            return this.name || ((this.startTime && this.endTime) ? (
                    getConcatId(this.startTimeType, this.startTime, this.startTimeAltType, this.startTimeAlt) +
                    ' - ' +
                    getConcatId(this.endTimeType, this.endTime, this.endTimeAltType, this.endTimeAlt)
                ) :
                'within-time');
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: 'within time',
        align: 'left',
        oneditprepare: function () {
            $("#node-input-addTimes").change(function () {
                if ($(this).is(':checked')) {
                    $(".add-times-row").show();
                } else {
                    $(".add-times-row").hide();
                }
            });
            $(".wt-offset-time").spinner({
                max: 1439,
                min: -1439
            });
            $("#node-input-property").typedInput({
                default: this.propertyType || 'global',
                types: ['msg', 'flow', 'global']
            });
            let typeTimeReq = {
                value: "entered",
                label: "timestamp",
                icon: "icons/node-red-contrib-sun-position/inputTypeTime.png",
                hasValue: true,
                validate: /^(0[0-9]|[0-9]|1[0-9]|2[0-3])(?::([0-5][0-9]))?\s*(pm?)?$/
            };
            let typeTimeOpt = {
                value: "entered",
                label: "timestamp",
                icon: "icons/node-red-contrib-sun-position/inputTypeTime.png",
                hasValue: true,
                validate: /^$|^(0[0-9]|[0-9]|1[0-9]|2[0-3])(?::([0-5][0-9]))?\s*(pm?)?$/
            };
            let typeTimeSun = {
                value: "pdsTime",
                label: "sun ",
                icon: "icons/node-red-contrib-sun-position/inputTypeSun.png",
                options: ['solarNoon', 'nadir', 'sunrise', 'sunset', 'sunriseEnd',
                    'sunsetStart', 'dawn', 'dusk', 'nauticalDawn', 'nauticalDusk',
                    'nightEnd', 'night', 'goldenHourEnd', 'goldenHour'
                ]
            };
            let typeTimeMoon = {
                value: "pdmTime",
                label: "moon ",
                icon: "icons/node-red-contrib-sun-position/inputTypeMoon.png",
                options: ['rise', 'set']
            };
            $("#node-input-startTime").typedInput({
                default: this.startTimeType || 'entered',
                types: [typeTimeReq, typeTimeSun, typeTimeMoon, 'msg', 'flow', 'global']
            });
            $("#node-input-endTime").typedInput({
                default: this.endTimeType || 'entered',
                types: [typeTimeReq, typeTimeSun, typeTimeMoon, 'msg', 'flow', 'global']
            });
            $("#node-input-startTimeAlt").typedInput({
                default: this.startTimeAltType || 'entered',
                types: [typeTimeOpt, typeTimeSun, typeTimeMoon, 'msg', 'flow', 'global']
            });
            $("#node-input-endTimeAlt").typedInput({
                default: this.endTimeAltType || 'entered',
                types: [typeTimeOpt, typeTimeSun, typeTimeMoon, 'msg', 'flow', 'global']
            });
            $("#node-input-addTimes").change();
        },
        oneditsave: function () {
            this.propertyType = $("#node-input-property").typedInput('type');
            this.startTimeType = $("#node-input-startTime").typedInput('type');
            this.endTimeType = $("#node-input-endTime").typedInput('type');
            this.startTimeAltType = $("#node-input-startTimeAlt").typedInput('type');
            this.endTimeAltType = $("#node-input-endTimeAlt").typedInput('type');
        },
    });
</script>