<script type="text/x-red" data-template-name="within-time-switch">
    <div class="form-row">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <hr>
    <div class="form-row block-noindent">
        <label for="node-input-startTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTime"></span></label>
        <input type="text" id="node-input-startTime" />
        <input type="hidden" id="node-input-startTimeType">
    </div>
    <div class="form-row block-indent1 within-time-switch-row-startOffset">
        <label for="node-input-startOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.startOffset"></span></label>
        <input id="node-input-startOffset" data-i18n="[placeholder]within-time-switch.placeholder.startOffset"></input>
        <input type="hidden" id="node-input-startOffsetType">
        <select id="node-input-startOffsetMultiplier" class="node-input-multiplier"></select>
    </div>

    <div class="form-row block-noindent">
        <label for="node-input-endTime"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTime"></span></label>
        <input type="text" id="node-input-endTime" />
        <input type="hidden" id="node-input-endTimeType">
    </div>
    <div class="form-row block-indent1 within-time-switch-row-endOffset">
        <label for="node-input-endOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.endOffset"></span></label>
        <input id="node-input-endOffset" data-i18n="[placeholder]within-time-switch.placeholder.endOffset"></input>
        <input type="hidden" id="node-input-endOffsetType">
        <select id="node-input-endOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <hr>
    <div class="form-tips">
        <span data-i18n="[html]within-time-switch.tips.addTimes"></span>&nbsp;
    </div>
    <div class="form-row"/>
    <div class="form-row alternate-property-start">
        <label for="node-input-propertyStart"><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.propertyStart"></span></label>
        <input type="text" id="node-input-propertyStart"/>
        <input type="hidden" id="node-input-propertyStartType">
    </div>
    <div class="form-row block-indent1 alternate-time-start hidden">
        <label for="node-input-startTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.startTimeAlt"></span></label>
        <input type="text" id="node-input-startTimeAlt"/>
        <input type="hidden" id="node-input-startTimeAltType">
    </div>
    <div class="form-row block-indent1 alternate-time-start-offset hidden">
        <label for="node-input-startTimeAltOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.startTimeAltOffset"></span></label>
        <input id="node-input-startTimeAltOffset" data-i18n="[placeholder]within-time-switch.placeholder.startTimeAltOffset"></input>
        <input type="hidden" id="node-input-startTimeAltOffsetType">
        <select id="node-input-startTimeAltOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <div class="form-row alternate-property-end">
        <label for="node-input-propertyEnd"><i class="fa fa-sun-o"></i> <span data-i18n="within-time-switch.label.propertyEnd"></span></label>
        <input type="text" id="node-input-propertyEnd"/>
        <input type="hidden" id="node-input-propertyEndType">
    </div>
    <div class="form-row block-indent1 alternate-time-end hidden">
        <label for="node-input-endTimeAlt"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.endTimeAlt"></span></label>
        <input type="text" id="node-input-endTimeAlt"/>
        <input type="hidden" id="node-input-endTimeAltType">
    </div>
    <div class="form-row block-indent1 alternate-time-end-offset hidden">
        <label for="node-input-endTimeAltOffset"><i class="fa fa-calculator"></i> <span data-i18n="within-time-switch.label.endTimeAltOffset"></span></label>
        <input id="node-input-endTimeAltOffset" data-i18n="[placeholder]within-time-switch.placeholder.endTimeAltOffset"></input>
        <input type="hidden" id="node-input-endTimeAltOffsetType">
        <select id="node-input-endTimeAltOffsetMultiplier" class="node-input-multiplier"></select>
    </div>
    <hr>
    <div class="form-row">
        <a href="#" class="enhanced-row-toggle"><span data-i18n="within-time-switch.label.showEnhSettings"></span></a>
    </div>
    <div class="form-row enhanced-row hidden">
            <div class="form-row compare-row">
                <label for="node-input-tsCompare"><i class="fa fa-clock-o"></i> <span data-i18n="within-time-switch.label.compareTime"></span></label>
                <select id="node-input-tsCompare" style="width:70%;" >
                    <option value="0" data-i18n="within-time-switch.label.now"></option>
                    <option value="1" data-i18n="within-time-switch.label.msgts"></option>
                    <option value="2" data-i18n="within-time-switch.label.msglc"></option>
                    <option value="3" data-i18n="within-time-switch.label.msgtime"></option>
                    <option value="4" data-i18n="within-time-switch.label.msgvalue"></option>
                </select>
            </div>
            <div class="form-row debug-row">
            <label for="node-input-statusOut"><i class="fa fa-bug"></i> <span data-i18n="within-time-switch.label.statusOut"></span></label>
            <select id="node-input-statusOut"  style="width:70%;" >
                <option value="0" data-i18n="within-time-switch.label.statusOnlyError"></option>
                <option value="1" data-i18n="within-time-switch.label.statusTime"></option>
                <option value="2" data-i18n="within-time-switch.label.statusSend"></option>
                <option value="3" data-i18n="within-time-switch.label.statusTimeOrSend"></option>
                <option value="256" data-i18n="within-time-switch.label.statusNone"></option>
            </select>
        </div>
        <div class="form-row msg-start-out-row">
            <label for="node-input-lastMsgOnStartOut"><i class="fa fa-forward"></i> <span data-i18n="within-time-switch.label.lastMsgOnStartOut"></span></label>
            <input type="checkbox" id="node-input-lastMsgOnStartOut" style="display:inline-block; width:15px; vertical-align:baseline;">
            <span data-i18n="within-time-switch.label.lastMsgOnStartOutTxt"></span>
        </div>
        <div class="form-row msg-end-out-row">
            <label for="node-input-lastMsgOnEndOut"><i class="fa fa-fast-forward"></i> <span data-i18n="within-time-switch.label.lastMsgOnEndOut"></span></label>
            <input type="checkbox" id="node-input-lastMsgOnEndOut" style="display:inline-block; width:15px; vertical-align:baseline;">
            <span data-i18n="within-time-switch.label.lastMsgOnEndOutTxt"></span>
        </div>
    </div>
    <hr>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>
<style>
    hr {
        width: 100%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 100%
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 100%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .node-input-multiplier {
        width: 125px;
        margin-left: 5px;
    }
</style>

<script type="text/javascript">
    function clipValueLength(v, l) {
        if (v.length > l) {
            return v.substring(0, (l - 3)) + '...';
        }
        return v;
    }

    function getValueLabel(node, t, v, offset, l) {
        l = l || 15;
        let suffix = '';
        if (offset && offset > 0) {
            suffix = '↷';
        } else if (offset && offset < 0) {
            suffix = '↶';
        }

        if (t === 'jsonata') {
            if (v.length < l) { return v + suffix; }
            return node._('node-red-contrib-sun-position/position-config:common.label.jsonata') + suffix;
        }

        if (t === 'json') {
            if (v.length < l) { return  v + suffix; }
            return node._('node-red-contrib-sun-position/position-config:common.label.json') + suffix;
        }

        if (t === 'bin') {
            return node._('node-red-contrib-sun-position/position-config:common.label.binary') + suffix;
        }

        if (t === 'date') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + suffix;
        }

        if (t === 'dateSpecific') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + '+' + suffix;
        }

        if (t === 'string' || t === 'str' || t === 'DayOfMonth') {
            if (v === '') { return node._('node-red-contrib-sun-position/position-config:common.label.blank') + suffix; }
            return '"' + clipValueLength(v, l) + '"' + suffix;
        }

        if (t === 'num') {
            if (v === '') { return '0' + suffix; }
            return String(v) + suffix;
        }

        if (t === 'bool') {
            if (v === '') { return 'false' + suffix; }
            return String(v) + suffix;
        }

        if (t === 'msg') {
            return t + '.' + clipValueLength(v, l) + suffix;
        }

        if (t === 'flow' || t === 'global') {
            const result = RED.utils.parseContextKey(v);
            return t + '.' + clipValueLength(result.key, l) + suffix;
        }

        if (t === 'pdsCalcData') {
            return '{sun position}' + suffix;
        }

        if (t === 'pdmCalcData') {
            return '{moon position}' + suffix;
        }

        if (t === 'pdsTime') {
            const res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('civil', '').replace('amateur', 'amat-').replace('blueHour', 'blHr-').replace('goldenHour', 'goHr-');
            return clipValueLength(res, l) + suffix;
        }

        if (t === 'pdmTime') {
            return 'moon' + v + suffix;
        }

        if (t === 'msgPayload') { return 'msg.payload'; }
        if (t === 'msgTs') { return 'msg.ts'; }
        if (t === 'msgLc') { return 'msg.lc'; }
        if (t === 'msgValue') { return 'msg.value'; }

        if (v === '') {
            return node._('node-red-contrib-sun-position/position-config:common.label.blank');
        }

        return clipValueLength(v, l) + suffix;
    }

    RED.nodes.registerType('within-time-switch', {
        category: 'time and astro',
        color: '#f37a33',
        icon: 'switch-white.png',
        inputs: 1,
        outputs: 2,
        defaults: {
            name: {
                value: '',
                required: false
            },
            positionConfig: {
                value: '',
                type: 'position-config',
                required: true
            },
            startTime: {
                value: '',
                required: true,
                validate: RED.validators.typedInput('startTimeType')
            },
            startTimeType: {
                value: 'entered'
            },
            startOffset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.startOffsetType === 'undefined') ||
                        RED.validators.typedInput('startOffsetType')(v)
                    );
                }
            },
            startOffsetType: {
                value: 'none'
            },
            startOffsetMultiplier: {
                value: 60000,
                required: true,
                validate: RED.validators.number()
            },
            endTime: {
                value: '',
                required: true,
                validate: RED.validators.typedInput('endTimeType')
            },
            endTimeType: {
                value: 'entered'
            },
            endOffset: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.endOffsetType === 'undefined') ||
                        RED.validators.typedInput('endOffsetType')(v)
                    );
                }
            },
            endOffsetType: {
                value: 'none'
            },
            endOffsetMultiplier: {
                value: 60000,
                required: true,
                validate: RED.validators.number()
            },
            propertyStart: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('propertyStartType')
            },
            propertyStartType: {
                value: 'none'
            },
            startTimeAlt: {
                value: '',
                required: false,
                validate: (v) => {
                    return RED.validators.typedInput('startTimeAltType')(v) || ($(
                        '#node-input-propertyStart').typedInput(
                        'type') === 'none');
                }
            },
            startTimeAltType: {
                value: 'none'
            },
            startOffsetAlt: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.startOffsetAltType === 'undefined') ||
                        RED.validators.typedInput('startOffsetAltType')(v) ||
                        ($('#node-input-propertyStart').typedInput('type') === 'none') ||
                        ($('#node-input-startTimeAlt').typedInput('type') === 'none')
                    );
                }
            },
            startOffsetAltType: {
                value: 'none'
            },
            startOffsetAltMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) ||
                    ($('#node-input-propertyStart').typedInput('type') === 'none') ||
                    ($('#node-input-startTimeAlt').typedInput('type') === 'none');
                }
            },
            propertyEnd: {
                value: '',
                required: false,
                validate: RED.validators.typedInput('propertyEndType')
            },
            propertyEndType: {
                value: 'none'
            },
            endTimeAlt: {
                value: '',
                required: false,
                validate: (v) => {
                    return RED.validators.typedInput('endTimeAltType')(v) || ($('#node-input-propertyEnd').typedInput(
                        'type') === 'none');
                }
            },
            endTimeAltType: {
                value: 'none'
            },
            endOffsetAlt: {
                value: 0,
                validate: (v) => {
                    return (
                        (typeof v === 'undefined') ||
                        (typeof this.startOffsetAltType === 'undefined') ||
                        RED.validators.typedInput('startOffsetAltType')(v) ||
                        ($('#node-input-propertyEnd').typedInput('type') === 'none') ||
                        ($('#node-input-endTimeAlt').typedInput('type') === 'none')
                    );
                }
            },
            endOffsetAltType: {
                value: 'none'
            },
            endOffsetAltMultiplier: {
                value: 60000,
                required: true,
                validate: (v) => {
                    return RED.validators.number()(v) ||
                    ($('#node-input-propertyEnd').typedInput('type') === 'none') ||
                    ($('#node-input-endTimeAlt').typedInput('type') === 'none');
                }
            },
            tsCompare: {
                value: '0'
            },
            statusOut: {
                value: 3,
                required: false
            },
            lastMsgOnStartOut: {
                value: false,
                required: false
            },
            lastMsgOnEndOut: {
                value: false,
                required: false
            }
        },
        outputLabels: ['within time', 'out of time'],
        label() {
            const getConcatId = (type1, value1, offset1, property, type2, value2, offset2) => {
                if (property !== 'none' && property !== '' && value2) {
                    return getValueLabel(this, type1, value1, offset1, 12) + '/' + getValueLabel(this, type2, value2, offset2, 12);
                }

                return getValueLabel(this, type1, value1, undefined, 12);
            };

            if (this.name) {
                return this.name;
            }

            if (this.startTime && this.endTime) {
                return getConcatId(this.startTimeType, this.startTime, this.startOffset, this.propertyStartType,
                    this.startTimeAltType, this.startTimeAlt, this.startOffsetAlt) +
            ((this.lastMsgOnStartOut) ? '⨧ - ' : ' - ') +
            getConcatId(this.endTimeType, this.endTime, this.endOffset, this.propertyEndType,
                this.endTimeAltType, this.endTimeAlt, this.endTimeAltOffset) +
            ((this.lastMsgOnEndOut) ? '⨧' : '');
            }

            return 'within-time';
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'within-time',
        align: 'left',
        oneditprepare() {
            $('.enhanced-row-toggle').on('click', () => {
                $('.enhanced-row').toggle(); // .hide();
            });

            const node = this;
            const setup = function(node) {
                /* global getTypes appendOptions setupTInput initializeValue */
                const types = getTypes(node);
                // #region initialize
                function multilpierUpdate(mp, name) {
                    const field = $('#node-input-' + name);
                    appendOptions(node, field, 'multiplier', (id) => (id > 0));
                    if (mp === null || typeof mp === 'undefined' || isNaN(mp) || mp === '' || mp === 0) {
                        mp = 60000;
                    } else {
                        mp = parseFloat(mp);
                        if (mp === 1) {
                            mp = 1000;
                        } else if (mp === 60) {
                            mp = 60000;
                        } else if (mp === 3600) {
                            mp = 3600000;
                        }
                    }
                    field.val(mp);
                    return mp;
                }
                // #endregion initialize
                // #region timeStart
                const startTimeTypeField = setupTInput(node, {
                    typeProp: 'startTimeType',
                    valueProp: 'startTime',
                    width: 'calc(100% - 110px)',
                    defaultType: node.startTimeType || types.TimeEntered.value,
                    defaultValue: node.startTime || '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon,  'msg', 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        const plVType = $('#node-input-startTime').typedInput('type');
                        const plVTypeAlt = $('#node-input-startTimeAlt').typedInput('type');
                        if (plVType ===  'msg' ||
                            plVType === 'flow' ||
                            plVType === 'global' ||
                            plVTypeAlt === 'msg' ||
                            plVTypeAlt === 'flow' ||
                            plVTypeAlt === 'global') {
                            $('.msg-start-out-row').hide();
                        } else {
                            $('.msg-start-out-row').show();
                        }
                    }
                });

                node.startOffsetMultiplier = multilpierUpdate(node.startOffsetMultiplier, 'startOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'startOffsetType',
                    valueProp: 'startOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.startOffset === 0 || node.startOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-startOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-startOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-startOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeStart
                // #region timeEnd
                const endTimeTypeField = setupTInput(node, {
                    typeProp: 'endTimeType',
                    valueProp: 'endTime',
                    width: 'calc(100% - 110px)',
                    defaultType: node.endTimeType || types.TimeEntered.value,
                    defaultValue: node.endTime || '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon,  'msg', 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        const plVType = $('#node-input-endTime').typedInput('type');
                        const plVTypeAlt = $('#node-input-endTimeAlt').typedInput('type');
                        if (plVType ===  'msg' ||
                            plVType === 'flow' ||
                            plVType === 'global' ||
                            plVTypeAlt === 'msg' ||
                            plVTypeAlt === 'flow' ||
                            plVTypeAlt === 'global') {
                            $('.msg-end-out-row').hide();
                        } else {
                            $('.msg-end-out-row').show();
                        }
                    }
                });

                node.endOffsetMultiplier = multilpierUpdate(node.endOffsetMultiplier, 'endOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'endOffsetType',
                    valueProp: 'endOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.endOffset === 0 || node.endOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-endOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-endOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-endOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeEnd
                // #region propertyStart
                const propertyStartTypeField = setupTInput(node, {
                    typeProp: 'propertyStartType',
                    valueProp: 'propertyStart',
                    width: 'calc(100% - 110px)',
                    defaultType: node.propertyStartType  || types.Undefined.value,
                    defaultValue: node.propertyStartValue || '' ,
                    types: [types.Undefined, 'msg', 'flow', 'global', 'jsonata', 'env'],
                    onChange: (_type, _value) => {
                        if ($('#node-input-propertyStart').typedInput('type') === 'none') {
                            $('.alternate-time-start').hide();
                            $('.alternate-time-start-offset').hide();
                        } else {
                            $('.alternate-time-start').show();
                        }

                        $('#node-input-startTimeAlt').change();
                    }
                });
                // #endregion propertyStart
                // #region timeAltStart
                setupTInput(node, {
                    typeProp: 'startTimeAltType',
                    valueProp: 'startTimeAlt',
                    width: 'calc(100% - 110px)',
                    defaultType: 'entered',
                    defaultValue: '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon, 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        if (($('#node-input-startTimeAlt').typedInput('type') === 'none') ||
                            ($('#node-input-propertyStart').typedInput('type') === 'none')) {
                            $('.alternate-time-start-offset').hide();
                        } else {
                            $('.alternate-time-start-offset').show();
                        }
                    }
                }).change();

                node.startTimeAltOffsetMultiplier = multilpierUpdate(node.startTimeAltOffsetMultiplier, 'startTimeAltOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'startTimeAltOffsetType',
                    valueProp: 'startTimeAltOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.startTimeAltOffset === 0 || node.startTimeAltOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-startTimeAltOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-startTimeAltOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-startTimeAltOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeAltStart
                // #region propertyEnd
                const propertyEndTypeField = setupTInput(node, {
                    typeProp: 'propertyEndType',
                    valueProp: 'propertyEnd',
                    width: 'calc(100% - 110px)',
                    defaultType: node.propertyEndType  || types.Undefined.value,
                    defaultValue: node.propertyEndValue || '' ,
                    types: [types.Undefined, 'msg', 'flow', 'global', 'jsonata', 'env'],
                    onChange: (_type, _value) => {
                        if ($('#node-input-propertyEnd').typedInput('type') === 'none') {
                            $('.alternate-time-end').hide();
                            $('.alternate-time-end-offset').hide();
                        } else {
                            $('.alternate-time-end').show();
                        }

                        $('#node-input-endTimeAlt').change();
                    }
                });
                // #endregion propertyEnd
                // #region timeAltEnd
                setupTInput(node, {
                    typeProp: 'endTimeAltType',
                    valueProp: 'endTimeAlt',
                    width: 'calc(100% - 110px)',
                    defaultType: 'entered',
                    defaultValue: '',
                    types: [types.TimeEntered, types.TimeSun, types.TimeMoon, 'flow', 'global', 'env'],
                    onFocus: (_type, _value) => {
                        if (($('#node-input-startTimeAlt').typedInput('type') === 'none') ||
                            ($('#node-input-propertyStart').typedInput('type') === 'none')) {
                            $('.alternate-time-start-offset').hide();
                        } else {
                            $('.alternate-time-start-offset').show();
                        }
                    }
                }).change();

                node.endTimeAltOffsetMultiplier = multilpierUpdate(node.endTimeAltOffsetMultiplier, 'endTimeAltOffsetMultiplier');
                setupTInput(node, {
                    typeProp: 'endTimeAltOffsetType',
                    valueProp: 'endTimeAltOffset',
                    width: 'calc(100% - 255px)',
                    defaultType: (node.endTimeAltOffset === 0 || node.endTimeAltOffset === '') ? types.Undefined.value : 'num',
                    defaultValue: 0,
                    types: [types.Undefined, 'num', 'flow', 'global', 'env'],
                    onChange: (_type, _value) => {
                        const type = $('#node-input-endTimeAltOffset').typedInput('type');
                        if (type === types.Undefined.value) {
                            $('#node-input-endTimeAltOffsetMultiplier').prop('disabled', true);
                        } else {
                            $('#node-input-endTimeAltOffsetMultiplier').prop('disabled', false);
                        }
                    }
                }).change();
                // #endregion timeAltEnd
                // #region Enhanced settings
                initializeValue(node, 'tsCompare', 0);
                initializeValue(node, 'statusOut', 3);
                const chkVal = (name, val) => {
                    console.log(name + ' compare to ' + val + ' - ' +
                    (node[name] === null) ||
                            (typeof node[name] === 'undefined') ||
                            ($('#node-input-' + name).val() === val) ||
                            (parseFloat($('#node-input-' + name).val()) === val));
                    console.log(node[name]);
                    console.log(typeof node[name]);
                    console.log($('#node-input-' + name).val());
                    console.log($('#node-input-' + name).is(':checked'));
                    console.log(parseFloat($('#node-input-' + name).val()));
                    return (node[name] === null) ||
                            (typeof node[name] === 'undefined') ||
                            ($('#node-input-' + name).val() === val) ||
                            ($('#node-input-' + name).is(':checked') === val) ||
                            (parseFloat($('#node-input-' + name).val()) === val);
                };

                if (chkVal('lastMsgOnStartOut', false) &&
                    chkVal('lastMsgOnEndOut', false) &&
                    chkVal('statusOut', 3) &&
                    chkVal('tsCompare', 0)) {
                    console.log('hide');
                    $('.enhanced-row').hide();
                } else {
                    console.log('show');
                    $('.enhanced-row').show();
                }
                // #endregion Enhanced settings
                startTimeTypeField.change();
                endTimeTypeField.change();
                propertyStartTypeField.change();
                propertyEndTypeField.change();
            }; // setup

            $.getScript('sun-position/js/htmlglobal.js')
                .done((_data, _textStatus, _jqxhr) => {
                    try {
                        setup(node);
                    } catch (err) {
                        console.log("failed to setup editor"); // eslint-disable-line
                        console.log(err); // eslint-disable-line
                        console.log(err.stack); // eslint-disable-line
                    }
                })
                .fail((jqxhr, settings, exception) => {
                    console.log("failed to load htmlglobal.js"); // eslint-disable-line
                    console.log(exception); // eslint-disable-line
                    console.log(exception.stack); // eslint-disable-line
                });
        },
        oneditsave() {
            this.propertyStartType = $('#node-input-propertyStart').typedInput('type');
            this.propertyEndType = $('#node-input-propertyEnd').typedInput('type');
            this.startTimeType = $('#node-input-startTime').typedInput('type');
            this.endTimeType = $('#node-input-endTime').typedInput('type');
            this.startTimeAltType = $('#node-input-startTimeAlt').typedInput('type');
            this.endTimeAltType = $('#node-input-endTimeAlt').typedInput('type');
        }
    });</script>