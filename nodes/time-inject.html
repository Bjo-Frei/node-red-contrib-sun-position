<script type="text/x-red" data-template-name="time-inject">
    <div class="form-row">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="time-inject.label.position"></span></label>
        <input type="text" id="node-input-positionConfig">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-input-time"><i class="fa fa-clock-o"></i> <span data-i18n="time-inject.label.time"></span></label>
        <input type="text" id="node-input-time" style="width: 70%"/>
        <input type="hidden" id="node-input-timeType">
    </div>
    <div class="form-row time-row time-offset hidden">
        <label for="node-input-offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-inject.label.offset"></span></label>
        <input id="node-input-offset"" class="wt-offset-time" data-i18n="[placeholder]time-inject.placeholder.offset">
        <select style="width:100px" id="node-input-offsetMultiplier">
            <option value="1" data-i18n="time-inject.label.seconds"></option>
            <option value="60" data-i18n="time-inject.label.minutes"></option>
            <option value="3600" data-i18n="time-inject.label.hours"></option>
        </select><br/>
        <div id="time-inject-timeDays" class="time-inject-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="time-inject.label.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="time-inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="time-inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="time-inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="time-inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="time-inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="time-inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="time-inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="form-row time-row time-payload hidden">
        <label for="node-input-payload"><i class="fa fa-envelope"></i> <span data-i18n="time-inject.label.payload"></span></label>
        <input type="text" id="node-input-payload" style="width:70%">
        <input type="hidden" id="node-input-payloadType">
    </div>
    <div class="form-row time-row time-topic hidden">
        <label for="node-input-topicStart"><i class="fa fa-tasks"></i> <span data-i18n="time-inject.label.topicStart"></span></label>
        <input type="text" id="node-input-topicStart">
    </div>
    <hr>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="time-inject.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]time-inject.placeholder.name">
    </div>

    <div class="form-tips" data-i18n="[html]time-inject.tip"></div>
  </script>
  <style>
    .time-inject-row {
        padding-left: 110px;
    }
    .time-inject-row select {
        margin: 3px 0;
    }
    .time-inject-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }
    .time-inject-days input {
        width: auto;
        vertical-align: baseline;
    }
    .time-inject-times {
        width: 90px;
    }
    #time-inject-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .time-inject-count {
        width: 40px !important;
    }
</style>

<script type="text/x-red" data-help-name="time-inject">
    <p>Uses the suncalc module to generate an output at sunrise and sunset based on a specified location.</p>
      <p>Several choices of definition of sunrise and sunset are available, see the <i><a href = "https://github.com/mourner/suncalc" target="_new">suncalc</a></i> module for details.</p>
      <p>The first output emits a <code>msg.payload</code> of <i>1</i> or <i>0</i> every minute depending if in between selected times or not.
      The second output emits only on the transition between night to day (<i>-> 1</i>) or day to night (<i>-> 0</i>).</p>
      <p>Also sets <code>msg.topic</code> to <i>sun</i> and <code>msg.moon</code> to the fraction of the moon between 0 and 1.</p>
  </script>

<script type="text/javascript">
    RED.nodes.registerType('time-inject', {
        category: 'input',
        color: "#a6bbcf",
        defaults: {
            name: {
                value: "",
                required: false
            },
            positionConfig: {
                value: "",
                type: "position-config",
                required: true
            },
            time: {
                value: "",
                required: false,
                validate: RED.validators.typedInput("timeType")
            },
            timeType: {
                value: "none"
            },
            timeDays: {
                value: "*"
            },
            offset: {
                value: 0,
                required: true,
                validate: function (v) {
                    return RED.validators.number()(v) ||
                        ($("#node-input-time").typedInput('type') === 'none');
                }
            },
            offsetMultiplier: {
                value: 60,
                required: true,
                validate: function (v) {
                    return RED.validators.number()(v) ||
                        ($("#node-input-time").typedInput('type') === 'none');
                }
            },
            payload: {
                value: "",
                validate: function (v) {
                    return RED.validators.typedInput("payloadType")(v) ||
                        ($("#node-input-time").typedInput('type') === 'none');
                }
            },
            payloadType: {
                value: "date"
            },
            topic: {
                value: ""
            }
        },
        icon: "injectSun.png",
        inputs: 0,
        outputs: 1,
        outputLabels: ["once per minute", "only on change"],
        label: function () {
            if (this.name) {
                return this.name;
            }
            var result = "";
            const getId = (type, value) => {
                if (type === "string" ||
                    type === "str" ||
                    type === "num" ||
                    type === "bool") {
                    if (value=='') {
                        return this._("time-inject.label.blank");
                    }
                    return value;
                } else if (type === 'jsonata') {
                    if (value.length < 15) {
                        return value;
                    }
                    return this._("time-inject.label.jsonata");;
                } else if (type === 'json') {
                    if (value.length < 15) {
                        return value;
                    }
                    return this._("time-inject.label.json");
                } else if (type === 'bin') {
                    return this._("time-inject.label.binary");
                } else if (type === 'date') {
                    return this._("time-inject.label.timestamp");
                } else if (type === 'flow' || type === 'global') {
                    return type + '.' + value;
                } else if (type == 'pdmTime') {
                    return 'moon ' + value;
                }
                return value;
            }
            if (this.timeType === 'none' || this.timeType === '') {
                return this._("time-inject.label.inject");
            } else {
                let part1 = getId(this.timeType, this.time);
                if (part1.length > 24) {
                    result += part1 + '=...';
                } else {
                    result += part1 + '=' + getId(this.payloadType, this.payload);
                }
            }
            if (this.topic && (this.topic.length + result.length <= 32)) {
                return this.topic + ":" + result;
            }
            return result;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: 'time inject',
        align: 'left',
        oneditprepare: function () {
            if (this.payloadType == null) {
                if (this.payload == "") {
                    this.payloadType = "date";
                } else {
                    this.payloadType = "str";
                }
            } else if (this.payloadType === 'string' || this.payloadType === 'none') {
                this.payloadType = "str";
            }
            let typeTimeNone = {
                value: "none",
                label: "not used",
                icon: "icons/node-red-contrib-sun-position/inputTypeNone.png",
                hasValue: false
            };
            let typeTime = {
                value: "entered",
                label: "timestamp",
                icon: "icons/node-red-contrib-sun-position/inputTypeTime.png",
                hasValue: true,
                validate: /^(0[0-9]|[0-9]|1[0-9]|2[0-3])(?::([0-5][0-9]|[0-9]))?(?::([0-5][0-9]|[0-9]))?\s*(pm?)?$/
            };
            let typeTimeSun = {
                value: "pdsTime",
                label: "sun ",
                icon: "icons/node-red-contrib-sun-position/inputTypeSun.png",
                options: ['solarNoon', 'nadir', 'sunrise', 'sunset', 'sunriseEnd',
                    'sunsetStart', 'dawn', 'dusk', 'nauticalDawn', 'nauticalDusk',
                    'nightEnd', 'night', 'goldenHourEnd', 'goldenHour'
                ]
            };
            let typeTimeMoon = {
                value: "pdmTime",
                label: "moon ",
                icon: "icons/node-red-contrib-sun-position/inputTypeMoon.png",
                options: ['rise', 'set']
            };
            $("#node-input-timeType").val(this.timeType);
            $("#node-input-time").typedInput({
                default: this.timeType || 'none',
                typeField: $("#node-input-timeType"),
                types: [typeTimeNone, typeTime, typeTimeSun, typeTimeMoon, 'flow', 'global']
            });
            $("#node-input-time").on('change', function (type, value) {
                if ($("#node-input-time").typedInput('type') === 'none') {
                    $(".time-row").hide();
                } else {
                    $(".time-row").show();
                }
            });
            $("#node-input-payloadType").val(this.payloadType);
            $("#node-input-payload").typedInput({
                default: this.payloadType || 'date',
                typeField: $("#node-input-payloadType"),
                types: ['flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'env',
                    'jsonata'
                ]
            });
            $(".wt-offset-time").spinner({
                max: 1439,
                min: -1439
            });
            if (this.timeDays == "*") {
                $("#time-inject-timeDays input[type=checkbox]").prop("checked",true);
            } else {
                $("#time-inject-timeDays input[type=checkbox]").removeAttr("checked");
                this.timeDays.split(",").forEach(function(v) {
                    $("#time-inject-timeDays [value=" + v + "]").prop("checked", true);
                });
            }

            $("#node-input-time").change();
        },
        oneditsave: function () {
            this.timeType = $("#node-input-time").typedInput('type');
            this.payloadType = $("#node-input-payload").typedInput('type');
            var days = $('#time-inject-timeDays input[type=checkbox]:checked').map(function(_, el) {
                return $(el).val()
            }).get();

            if (days.length == 0) {
                this.timeDays = "";
            } else {
                if (days.length == 7) {
                    this.timeDays="*";
                } else {
                    this.timeDays = days.join(",");
                }
            }
        },
        button: {
            enabled: function () {
                return !this.changed
            },
            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", {
                        message: RED._("notification.warnings.undeployedChanges")
                    }), "warning");
                }
                var payload = this.payload;
                if ((this.payloadType === 'flow') ||
                    (this.payloadType === 'global')) {
                    var key = RED.utils.parseContextKey(payload);
                    payload = this.payloadType + "." + key.key;
                }
                var label = (this.name || payload);
                if (label.length > 30) {
                    label = label.substring(0, 50) + "...";
                }
                label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.payloadType === "date") {
                    label = this._("time-inject.label.timestamp");
                }
                if (this.payloadType === "none") {
                    label = this._("time-inject.label.blank");
                }
                var node = this;
                $.ajax({
                    url: "inject/" + this.id,
                    type: "POST",
                    success: function (resp) {
                        RED.notify(node._("time-inject.label.success", {
                            label: label
                        }), "success");
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("time-inject.notification.error", {
                                message: node._(
                                    "time-inject.notification.errors.not-deployed")
                            }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("time-inject.notification.error", {
                                message: node._("time-inject.errors.failed")
                            }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("time-inject.notification.error", {
                                message: node._(
                                    "time-inject.notification.errors.no-response")
                            }), "error");
                        } else {
                            RED.notify(node._("time-inject.notification.error", {
                                message: node._(
                                    "time-inject.notification.errors.unexpected", {
                                        status: jqXHR.status,
                                        message: textStatus
                                    })
                            }), "error");
                        }
                    }
                });
            }
        }
    });
</script>