<!DOCTYPE HTML>

<script type="text/javascript">
    /**
     * get a value
     * @param {*} node - the node representation
     * @param {string} name - name of the value
     * @returns {*} the value of th element
     */
    function getVal(node,name) {
        const v = $('#node-input-' + name).val();
        if (v === undefined) {
            return node[name];
        }
        return v;
    }
    /**
     * count decimals
     * @param {number} value - a floating point number
     * @returns {number} number of decimals
     */
    function countDecimals(value) {
        return value === value>> 0 ? 0 : value.toString().split('.')[1].length || 0;
    }

    /**
     * get the min and maximum blind positions
     * @param {*} node - the node representation
     * @returns {object} object with property __min__ and __max__
     */
    function getMinMaxBlindPos(node) {
        let max = getVal(node, 'blindOpenPos');
        let min = getVal(node, 'blindClosedPos');
        if (max < min) {
            [min, max] = [max, min];
        }
        return { min, max };
    }

    /**
     * validates a blind position
     * @param {*} node - the node representation
     * @param {number} v - the blind position to validate
     * @returns {boolean} __true__ if the blind position is valide
     */
    function validateBlindPos(node, v) {
        const n = parseFloat(v);
        const inc = getVal(node, 'blindIncrement');
        const mm = getMinMaxBlindPos(node);

        return RED.validators.number(v) &&
                (v !== '') &&
                (n <= mm.max) &&
                (n >= mm.min) &&
                Number.isInteger(Number((n / inc).toFixed(countDecimals(inc) + 2)));
    }
    /**
     * save rules
     * @param {number} rules - output of the editableList
     * @returns {number} number of decimals
     */
    function saveRules(rules) {
        const result = [];
        if (rules) {
            rules.each(function (_i) {
                const rule = $(this);
                const data = JSON.parse(rule.data('ruleData'));
                data.index= _i;
                /* const data = {
                    index: _i,
                    timeValue: rule.find('.node-input-rule-time').typedInput('value'),
                    timeType: rule.find('.node-input-rule-time').typedInput('type'),
                    timeOp: rule.find('.node-input-rule-time-operator').val(),
                    timeOpText: rule.find('.node-input-rule-time-operator option:selected').text(),
                    levelValue: rule.find('.node-input-rule-level').typedInput('value'),
                    levelType: rule.find('.node-input-rule-level').typedInput('type'),
                    levelOp: rule.find('.node-input-rule-level-operator').val(),
                    levelOpText: rule.find('.node-input-rule-level-operator option:selected').text(),
                    offsetValue: rule.find('.node-input-rule-offset').typedInput('value'),
                    offsetType: rule.find('.node-input-rule-offset').typedInput('type'),
                    multiplier: rule.find('.node-input-rule-multiplier').val(),
                    validOperandAValue: rule.find('.node-input-rule-condOpA').typedInput('value'),
                    validOperandAType: rule.find('.node-input-rule-condOpA').typedInput('type'),
                    validOperator: rule.find('.node-input-rule-condOperator').val(),
                    validOperatorText: rule.find('.node-input-rule-condOperator option:selected').text(),
                    validOperandBValue: rule.find('.node-input-rule-condOpB').typedInput('value'),
                    validOperandBType: rule.find('.node-input-rule-condOpB').typedInput('type')
                }; */
                result.push(data);
            });
        }
        return result;
    }

    /**
     * clip a test to a maximum length
     * @param {string} v text to clip
     * @param {number} l length to clip the text
     */
    function clipValueLength(v, l) {
        l = l || 15;
        if (v.length > l) {
            return v.slice(0, (l - 3)) + '...';
        }
        return v;
    }

    /**
     * clip a test to a maximum length
     * @param {string} v text to clip
     * @param {number} l length to clip the text
     */
    function clipValueLengthRight(v, l) {
        l = l || 15;
        if (v.length > l) {
            return '...' + v.slice(-(l - 3));
        }
        return v;
    }

    /**
     * get the label for a typed input vlaue
     * @param {*} node - the node object for getting i18N Data (node._())
     * @param {string} t - the type of the value
     * @param {string} v - the value
     * @param {number} [offset] - a optional offset to the value
     * @param {number} [l] - the desired maximum length (default = 18)
     * @returns {string} the value clipped to the given length
     */
    function getValueLabel(node, t, v, l) { // eslint-disable-line complexity
        l = l || 20;

        if (t === 'jsonata') {
            if (v.length < l) { return v; }
            return node._('node-red-contrib-sun-position/position-config:common.label.jsonata');
        }

        if (t === 'json') {
            if (v.length < l) { return  v; }
            return node._('node-red-contrib-sun-position/position-config:common.label.json');
        }

        if (t === 'bin') {
            return node._('node-red-contrib-sun-position/position-config:common.label.binary');
        }

        if (t === 'date') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp');
        }

        if (t === 'dateSpecific') {
            return node._('node-red-contrib-sun-position/position-config:common.label.timestamp') + '+';
        }

        if (t === 'string' || t === 'str' || t === 'dayOfMonth') {
            if (v === '') { return node._('node-red-contrib-sun-position/position-config:common.label.blank'); }
            return '"' + clipValueLength(v, l) + '"';
        }

        if (t === 'num') {
            if (v === '') { return '0'; }
            return String(v);
        }

        if (t === 'bool') {
            if (v === '') { return 'false'; }
            return String(v);
        }

        if (t === 'msg' || t === 'env') {
            return t + '.' + clipValueLengthRight(v, l);
        }

        if (t === 'flow' || t === 'global') {
            const result = RED.utils.parseContextKey(v);
            // special for Homematic Devices
            if (/^.+\[('|").{18,}('|")\].*$/.test(result.key)) {
                result.key = result.key.replace(/^.+\[('|")/, '').replace(/('|")\].*$/, '');
                return t + '.' + clipValueLengthRight(result.key, l);
            }
            return t + '.' + clipValueLengthRight(result.key, l);
        }

        if (t === 'pdsCalcData') {
            return '{sun position}';
        }

        if (t === 'pdsCalcPercent') {
            return '{sun in sky percent}';
        }

        if (t === 'pdmCalcData') {
            return '{moon position}';
        }

        if (t === 'pdmPhase') {
            return '{moon phase}';
        }

        if (t === 'pdsTime') {
            const res = v.replace('astronomical', 'astro-').replace('nautical', 'naut-').replace('amateur', 'amat-').replace('blueHour', 'blueHr-').replace('goldenHour', 'goldHr-');
            return clipValueLength(res, l);
        }

        if (t === 'pdmTime') {
            return 'moon' + v;
        }

        if (t === 'msgPayload') { return 'msg.payload'; }
        if (t === 'msgTs') { return 'msg.ts'; }
        if (t === 'msgLc') { return 'msg.lc'; }
        if (t === 'msgValue') { return 'msg.value'; }

        if (v === '') {
            return node._('node-red-contrib-sun-position/position-config:common.label.blank');
        }

        return clipValueLength(v, l);
    }

    /**
     * get a description of the rule rules
     * @param {object} data - a rule description
     * @returns {steing} description of the rule
     */
    function getRuleDescription(node, selFields, data) {
        let result = '';
        if (data.validOperandAType && data.validOperandAType !== 'none') {
            result += '<div>';
            result += '<i class="fa fa-code-fork" aria-hidden="true"></i> ';
            result += getValueLabel(node, data.validOperandAType,data.validOperandAValue);
            // result += RED._('node-red-contrib-sun-position/position-config:common.comparatorDescription.' + data.validOperator);
            result += ' ' + data.validOperatorText;
            let operatorCount = 1;
            const fields = selFields.comparator;
            const fieldsLength = fields.length;
            for (let index = 0; index < fieldsLength; index++) {
                const el = fields[index];
                if (el.id === data.validOperator) {
                    operatorCount = el.operatorCount;
                    break;
                }
            }

            if (operatorCount > 1) {
                result += ' ' + getValueLabel(node, data.validOperandBType, data.validOperandBValue);
            }
            result += '</div>';
        }
        if (data.timeType && data.timeType !== 'none') {
            result += '<div>';
            result += '<i class="fa fa-clock-o" aria-hidden="true"></i> ';
            result += data.timeOpText;
            result += ' ' + getValueLabel(node, data.timeType, data.timeValue);
            if (data.offsetType && data.offsetType !== 'none') {
                result += ' offset ' + getValueLabel(node, data.offsetType, data.offsetValue);
                result += ' * ' + data.multiplier/1000 + 's';
            }

            if (data.timeBType && data.timeBType !== 'none') {
                result += ' ' + data.timeBOpText + ' ';
                result += '<i class="fa fa-clock-o" aria-hidden="true"></i> ';
                result += ' ' + getValueLabel(node, data.timeBType, data.timeBValue);
                if (data.offsetBType && data.offsetBType !== 'none') {
                    result += ' offset ' + getValueLabel(node, data.offsetBType, data.offsetBValue);
                    result += ' * ' + data.multiplierB/1000 + 's';
                }
            }
            result += '</div>';
        }
        result += '<div>';
        if (typeof data.levelType !== 'undefined') {
            result += data.levelOpText + ' ' + getValueLabel(node, data.levelType, data.levelValue);
        } else {
            result += '-';
        }
        result += '</div>';
        return result;
    }

    /**
     * resizes a rule
     * @param {jQuery} rule - the jQuery selector of the rule
     */
    function resizeRule(rule) {
        return;
        /*
        try {
            const newWidth = rule.width() - 10;
            // row1
            const $validOperandALbl = rule.find('.node-input-rule-condOpA-lbl');
            const $validOperandA = rule.find('.node-input-rule-condOpA');
            const $validOperator = rule.find('.node-input-rule-condOperator');
            $validOperandALbl.width('auto');
            if ($validOperator.is(':visible')) {
                $validOperator.width(100);
                $validOperandA.typedInput('width', (newWidth - $validOperandALbl.width() - 135));
            } else {
                $validOperandA.typedInput('width', (newWidth - $validOperandALbl.width() - 15));
            }
            // row2
            const $validOperandBLbl = rule.find('.node-input-rule-condOpB-lbl');
            const $validOperandB = rule.find('.node-input-rule-condOpB');
            $validOperandBLbl.width('auto');
            $validOperandB.typedInput('width', (newWidth - $validOperandBLbl.width() - 10));
            // row3
            const $timeLbl = rule.find('.node-input-rule-time-lbl');
            const $timeOperator = rule.find('.node-input-rule-time-operator');
            const $time = rule.find('.node-input-rule-time');
            $timeLbl.width('auto');
            if ($timeOperator.is(':visible')) {
                $timeOperator.width(70);
                $time.typedInput('width', (newWidth - $timeLbl.width() - 103));
            } else {
                $time.typedInput('width', (newWidth - $timeLbl.width() - 33));
            }
            // row4
            const $offset = rule.find('.node-input-rule-offset');
            const $multiplier = rule.find('.node-input-rule-multiplier');
            const multiplierWidth = 125;
            $multiplier.width(multiplierWidth);
            $offset.typedInput('width', (newWidth - multiplierWidth - 50));
            // row5
            const $levelLbl = rule.find('.node-input-rule-level-lbl');
            const $level = rule.find('.node-input-rule-level');
            const $levelOperator = rule.find('.node-input-rule-level-operator');
            $levelLbl.width('auto');
            $levelOperator.width(40);
            $level.typedInput('width', (newWidth - $levelLbl.width() - 60 - 10));
        } catch (ex) {
            console.log(ex); // eslint-disable-line
        }
        /* */
    }

    RED.nodes.registerType('blind-control', {
        category: 'advanced-input',
        color: '#FFCC66',
        icon: 'blind-white.png',
        inputs: 1,
        outputs: 1,
        defaults: {
            name: {
                value: '',
                required: false
            },
            topic: {
                value: '',
                required: false
            },
            positionConfig: {
                value: '',
                type: 'position-config',
                required: true
            },
            outputs: { value: '1' },
            // #region blind settings
            blindIncrement: {
                value: 0.01,
                required: true,
                validate(v) {
                    const n = parseFloat(v);
                    const mm = getMinMaxBlindPos(this);

                    return (RED.validators.number(v) &&
                            (n <= mm.max) &&
                            (n >= mm.min) );
                }
            },
            blindOpenPos: {
                value: 1.00,
                required: true,
                validate(v) { // eslint-disable-line request-shorthand
                    const n = parseFloat(v);
                    return RED.validators.number(v) &&
                        (Number.isInteger(n / getVal(this, 'blindIncrement'))) &&
                        (n !== getVal(this, 'blindClosedPos'));
                }
            },
            blindClosedPos: {
                value: 0.00,
                required: true,
                validate(v) {
                    const n = parseFloat(v);
                    return RED.validators.number(v) &&
                            (Number.isInteger(n / getVal(this, 'blindIncrement'))) &&
                            (n !== getVal(this, 'blindOpenPos'));
                }
            },
            blindPosReverse: {
                value: false
            },
            blindPosDefault: {
                value: 'open (max)',
                validate: RED.validators.typedInput('blindPosDefaultType')
            },
            blindPosDefaultType: {
                value: 'levelFixed'
            },
            // #endregion blind settings
            // #region overwrite settings
            overwriteExpire: {
                value: '',
                required: false,
                validate(v) {
                    const n = parseFloat(v);
                    return (v === '') || (RED.validators.number(v) && (n >= 200) && (n < 0x7FFFFFFF));
                }
            },
            // #endregion overwrite settings
            // #region rule settings
            rules: {
                value: {}
            },
            // #endregion time settings
            // #region sun settings
            sunControlMode: {
                value: '0',
                required: true,
                validate(v) {
                    const n = Number(v);
                    return (RED.validators.number(v) && (n >= 0) && (n <= 2));
                }
            },
            sunFloorLength: {
                value: '',
                required: false,
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 1) ||
                            (v === '') ||
                            (v !== '' && RED.validators.number(v));
                }
            },
            sunMinAltitude: {
                value: '',
                required: false,
                validate(v) {
                    const n = parseFloat(v);
                    return (Number(getVal(this, 'sunControlMode')) <= 1) ||
                            (v === '') ||
                            (RED.validators.number(v) && (n >= 0) && (n <= 90));
                }
            },
            sunMinDelta: {
                value: '',
                required: false,
                validate(v) {
                    const n = parseFloat(v);
                    const mm = getMinMaxBlindPos(this);
                    return ((Number(getVal(this, 'sunControlMode')) <= 1) ||
                            (v === '') ||
                            (n <= mm.max) &&
                            (n >= mm.min) &&
                            (n >= getVal(this, 'blindIncrement')) );
                }
            },
            blindPosMin: {
                value: 'closed (min)',
                validate(v) {
                    return ((Number(getVal(this, 'sunControlMode')) <= 0) ||
                        RED.validators.typedInput('blindPosMinType')(v));
                }
            },
            blindPosMinType: {
                value: 'levelFixed'
            },
            blindPosMax: {
                value: 'open (max)',
                validate(v) {
                    return ((Number(getVal(this, 'sunControlMode')) <= 0) ||
                    RED.validators.typedInput('blindPosMaxType')(v));
                }
            },
            blindPosMaxType: {
                value: 'levelFixed'
            },
            smoothTime: {
                value: '',
                validate(v) {
                    const n = parseFloat(v);
                    return ((Number(getVal(this, 'sunControlMode')) <= 0) || (v === '') || (RED.validators.number(v) && (n > -2147483647) && (n < 0x7FFFFFFF)));
                }
            },
            // #endregion sun settings
            // #region window settings
            windowTop: {
                value: '',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (v !== '' && RED.validators.number(v));
                }
            },
            windowBottom: {
                value: '',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (v !== '' && RED.validators.number(v));
                }
            },
            windowAzimuthStart: {
                value: '',
                validate(v) {
                    const n = Number(v);
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (RED.validators.number(v) && (n >= -360) && (n <= 360) &&
                            (n < getVal(this, 'windowAzimuthEnd')) );
                }
            },
            windowAzimuthEnd: {
                value: '',
                validate(v) {
                    const n = Number(v);
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (RED.validators.number(v) && (n >= -360) && (n <= 360) &&
                            (n > getVal(this, 'windowAzimuthStart')) );
                }
            },
            // #endregion window settings
            // #region oversteering settings
            oversteerValue: {
                value: '',
                required: false,
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            RED.validators.typedInput('oversteerValueType')(v);
                }
            },
            oversteerValueType: {
                value: 'none'
            },
            oversteerCompare: {
                value: 'gte'
            },
            oversteerThreshold: {
                value: '',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            RED.validators.typedInput('oversteerThresholdType')(v);
                }
            },
            oversteerThresholdType: {
                value: 'num'
            },
            oversteerBlindPos: {
                value: 'open (max)',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                            (getVal(this, 'oversteerValueType') === 'none') ||
                            RED.validators.typedInput('oversteerBlindPosType')(v); // validateBlindPos(this, v);
                }
            },
            oversteerBlindPosType: {
                value: 'levelFixed'
            },
            oversteer2Value: {
                value: '',
                required: false,
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                        (getVal(this, 'oversteerValueType') === 'none') ||
                        RED.validators.typedInput('oversteer2ValueType')(v);
                }
            },
            oversteer2ValueType: {
                value: 'none'
            },
            oversteer2Compare: {
                value: 'gte'
            },
            oversteer2Threshold: {
                value: '',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                        (getVal(this, 'oversteerValueType') === 'none') ||
                        (getVal(this, 'oversteer2ValueType') === 'none') ||
                        RED.validators.typedInput('oversteer2ThresholdType')(v);
                }
            },
            oversteer2ThresholdType: {
                value: 'num'
            },
            oversteer2BlindPos: {
                value: 'open (max)',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                        (getVal(this, 'oversteerValueType') === 'none') ||
                        (getVal(this, 'oversteer2ValueType') === 'none') ||
                        RED.validators.typedInput('oversteer2BlindPosType')(v);
                }
            },
            oversteer2BlindPosType: {
                value: 'levelFixed'
            },
            oversteer3Value: {
                value: '',
                required: false,
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                        (getVal(this, 'oversteerValueType') === 'none') ||
                        (getVal(this, 'oversteer2ValueType') === 'none') ||
                        RED.validators.typedInput('oversteer3ValueType')(v);
                }
            },
            oversteer3ValueType: {
                value: 'none'
            },
            oversteer3Compare: {
                value: 'gte'
            },
            oversteer3Threshold: {
                value: '',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                        (getVal(this, 'oversteerValueType') === 'none') ||
                        (getVal(this, 'oversteer2ValueType') === 'none') ||
                        (getVal(this, 'oversteer3ValueType') === 'none') ||
                        RED.validators.typedInput('oversteer3ThresholdType')(v);
                }
            },
            oversteer3ThresholdType: {
                value: 'num'
            },
            oversteer3BlindPos: {
                value: 'open (max)',
                validate(v) {
                    return (Number(getVal(this, 'sunControlMode')) <= 0) ||
                        (getVal(this, 'oversteerValueType') === 'none') ||
                        (getVal(this, 'oversteer2ValueType') === 'none') ||
                        (getVal(this, 'oversteer3ValueType') === 'none') ||
                        RED.validators.typedInput('oversteer3BlindPosType')(v);
                }
            },
            oversteer3BlindPosType: {
                value: 'levelFixed'
            }
            // #endregion oversteering settings
        },
        outputLabels() {
            return [this._('blind-control.label.output1'), this._('blind-control.label.output2')];
        },
        label() {
            let suffix = '';
            if (this.rules && (this.rules.length >0)) {
                suffix += '⏲';
            }
            if (Number(this.sunControlMode) === 2) {
                suffix += '☀';
            } else if (Number(this.sunControlMode) === 1) {
                suffix += '☃';
            }
            if (this.name) {
                return this.name+' '+suffix;
            }
            const result = this._('blind-control.label.blind-control');
            if (this.topic && (this.topic.length + result.length <= 32)) {
                return this.topic + ':' + result+' '+suffix;
            }
            return result+' '+suffix;
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel() { return this._('blind-control.label.blind-control-palette'); },
        oneditprepare() {
            setTimeout(() => {
                $('.is-to-show-initially').show();
                $('.is-to-hide-initially').hide();
            }, 300);
            $('.rdg-ui-btn').button();

            this.outputs = this.outputs || 1;
            this.sunControlMode = this.sunControlMode || 0;
            const $nodeConfig = $('#node-input-positionConfig');
            const node = this;

            // #region Dialog
            /**
            const $dialogCtx = $('#dialog-select-context').dialog({
                autoOpen: false,
                height: 400,
                width: 600,
                modal: true
            });
            /* */
            // #endregion Dialog

            const setup = function(node) {
                /* global getTypes getSelectFields setupTInput appendOptions getBackendData bdDateToTime */
                // #region initialize
                const types = getTypes(node);
                const selFields = getSelectFields();

                types.LevelEntered = {
                    value: 'num',
                    label: node._('node-red-contrib-sun-position/position-config:common.types.levelfree', 'time (next)'),
                    icon: 'red/images/typedInput/09.png',
                    validate(v) { return validateBlindPos(this, v); }
                };
                types.LevelFix = {
                    value: 'levelFixed',
                    label: node._('node-red-contrib-sun-position/position-config:common.types.levelfix', 'time (next)'),
                    icon: 'icons/node-red-contrib-sun-position/inputTypeLevel.png',
                    options: [{
                        value: 'open (max)',
                        label: node._('blind-control.typeOptions.100')
                    }, {
                        value: '75%',
                        label: node._('blind-control.typeOptions.75')
                    }, {
                        value: '66%',
                        label: node._('blind-control.typeOptions.66')
                    }, {
                        value: '50%',
                        label: node._('blind-control.typeOptions.50')
                    }, {
                        value: '33%',
                        label: node._('blind-control.typeOptions.33')
                    }, {
                        value: '25%',
                        label: node._('blind-control.typeOptions.25')
                    }, {
                        value: '10%',
                        label: node._('blind-control.typeOptions.10')
                    }, {
                        value: 'closed (min)',
                        label: node._('blind-control.typeOptions.0')
                    }]
                };
                /**
                 * save rules
                 * @param {*} node - the node representation
                 * @param {string} name - the node representation
                 * @param {*} element - the node representation
                 * @param {number} rules - output of the editableList
                 * @returns {number} number of decimals
                */
                function setMultiplier(node, name, element, validate, defMultiplier) {
                    const c = Number(node[name]);
                    if (node[name] !== '' && !isNaN(c)) {
                        let r = 1000;
                        if (c % 3600000 === 0) {
                            r = 3600000;
                        } else if (c % 60000 === 0) {
                            r = 60000;
                        }
                        $('#time-control-' + name).val(c/r);
                        $('#time-control-' + name + '-multiplier').val(r);
                    } else {
                        $('#time-control-' + name).val('');
                        $('#time-control-' + name + '-multiplier').val(defMultiplier || 1000);
                    }
                    $('#time-control-' + name).on('change focus focusout', () => {
                        const el = $('#time-control-' + name);
                        let val = el.val();
                        const mp = $('#time-control-' + name + '-multiplier').val();
                        if (isNaN(val) || val === '' || val === 0) {
                            val = '';
                            $('node-input-' + name).val('');
                        } else {
                            val = val * mp;
                            $('#node-input-' + name).val(val);
                        }

                        if (typeof validate === 'function') {
                            if (validate(val)) {
                                el.removeClass( 'input-error' );
                            } else {
                                el.addClass( 'input-error' );
                            }
                        }
                    });

                    $('#time-control-' + name + '-multiplier').change( () => {
                        $('#time-control-' + name).change();
                    });
                    $('#time-control-' + name).change();
                }
                /**
                 * get the default level
                 * @param {string} type - the type value
                 * @param {string} value - value
                 * @param {string} def - the default value
                 * @returns {string} the default value for the level
                */
                function getDefLevel(type, value, def) {
                    // console.log(`getDefLevel "${type}", "${value}", "${def}"`);
                    if (value) {
                        return value;
                    }
                    if (!type || type === types.LevelFix.value) {
                        return def;
                    }
                    return def;
                }
                // #endregion initialize
                // #region blind
                setMultiplier(node,'overwriteExpire', v => {
                    const n = parseFloat(v);
                    return (v === '') || (RED.validators.number(v) && (n >= 200) && (n < 0x7FFFFFFF));
                }, 3600000);
                setupTInput(node, {
                    typeProp: 'blindPosDefaultType',
                    valueProp: 'blindPosDefault',
                    width: 'calc(100% - 110px)',
                    defaultType: types.LevelFix.value,
                    defaultValue: getDefLevel(node.blindPosDefaultType, node.blindPosDefault, 'open (max)'), // types.LevelFix.options[0],
                    types: [types.LevelFix, types.LevelEntered, 'env']
                });

                // #endregion blind
                // #region rules

                /**
                 * resizes a rule container
                 */
                function resizeContainer() {
                    try {
                        const editorRow = $('.node-input-rule-container-row ol');
                        const height = editorRow.outerHeight(true);
                        const rows = $('#node-input-rule-container').editableList('items');
                        if (rows.size() > 0) {
                            $('#node-input-rule-container').editableList('height', height + 40);
                        } else {
                            $('#node-input-rule-container').editableList('height', 20);
                        }
                    } catch (ex) {
                        console.log(ex); // eslint-disable-line
                    }
                }

                $('#node-input-rule-container').css('min-height', '40px').css('min-width', '300px').editableList({
                    addItem(containerRow, containerIndex, data) {
                        if (data === {}) {
                            data.description = 'please edit rule';
                            data.name = 'empty';
                        }
                        data.index = containerIndex;
                        data.timeType = (data.timeType || types.TimeEntered.value);
                        data.timeValue = (data.timeValue || '');
                        data.timeBType = (data.timeBType || types.Undefined.value);
                        data.timeBValue = (data.timeValue || '');
                        data.timeBOp = (data.timeBOp || 0);

                        data.name = data.name || 'rule ' + (containerIndex + 1);
                        if (!data.description) {
                            data.description = getRuleDescription(node, selFields, data);
                        }
                        containerRow.data('ruleData', JSON.stringify(data));
                        containerRow.css({ overflow: 'hidden'}); // , whiteSpace: 'nowrap'
                        const $row0 = $('<div/>').appendTo(containerRow);
                        const $div = $('<div/>', {
                            class: 'blind-rule-mainblock'
                        }).appendTo($row0);
                        $('<span />', {
                            id: 'rule-name-'+containerIndex,
                            class: 'blind-rule-name-span'
                        }).append(data.name).appendTo( $div );
                        $('<div />', {
                            id: 'rule-description-'+containerIndex,
                            class: 'blind-rule-description-span'
                        }).append(data.description).appendTo( $div );
                        const finalspan1 = $('<span/>',{
                            class:'blind-rule-finalspan'
                        }).appendTo($row0);
                        finalspan1.append('<span class="node-input-rule-index">'+(containerIndex+1)+'</span> ');
                        const $btn = $('<a />', {
                            class: 'red-ui-button red-ui-button-small blind-rule-editBtn'
                        }).append('<i class= "fa fa-pencil-square-o" ></i>').appendTo($row0);
                        // $btn.button();
                        $btn.click(() => {
                            _dialogLoadData(containerIndex, containerRow);
                        });
                    },
                    addButton: false,
                    resizeItem: resizeRule,
                    sortable: true,
                    removable: true,
                    scrollOnAdd: true,
                    removeItem(_opt) {
                        const rules = $('#node-input-rule-container').editableList('items');
                        rules.each(function(i) {
                            $(this).find('.node-input-rule-index').html(i+1);
                            const data = $(this).data('data');
                            data.index = i;
                        });
                        resizeContainer();
                    },
                    sortItems(_rules) {
                        const rules = $('#node-input-rule-container').editableList('items');
                        rules.each(function(i) {
                            $(this).find('.node-input-rule-index').html(i+1);
                            const data = $(this).data('data');
                            data.index = i;
                        });
                    }
                });

                // #region Button
                const $btnAdd = $('#node-button-add');
                $btnAdd.click(() => {
                    $('#node-input-rule-container').editableList('addItem', {});
                });

                const $btnClear = $('#node-button-clear');
                $btnClear.click(() => {
                    $('#node-input-rule-container').editableList('empty');
                    resizeContainer();
                });

                const $btnSort = $('#node-button-sort');
                $btnSort.click(() => {
                    const prerules = $('#node-input-rule-container').editableList('items');
                    prerules.each(function(i) {
                        const data = $(this).data('data');
                        data.index = i;
                        data.levelOp = (Number(data.levelOp) || 0);
                        data.conditional = ((data.validOperandAType !== 'none') ? 1 : 0);
                        data.timeLimited = ((data.timeType !== 'none') ? 1 : 0);
                        data.timeData = (parseFloat($(this).find('.node-input-rule-time').attr('timedata')) || 0);
                        data.timeOp = (data.timeLimited) ? (Number(data.timeOp) || 0) : -1;
                    });
                    /**
                     * 1 no time
                     * 2 time    - until
                     * 3 time    - from
                     */
                    $('#node-input-rule-container').editableList('sort', (a, b) => {
                        const pos = (a.index - b.index);
                        if (!a.timeLimited && !b.timeLimited) { // both not time limited
                            return pos;
                        }
                        // both are time limited
                        const top = (a.timeOp - b.timeOp);
                        if (top !== 0) {
                            return top; // from before until; not timeLimited before timeLimited (1-3)
                        }
                        // both same from/until type
                        /*
                        if ((a.levelOp > 2) && (b.levelOp <= 2)) { // time is different
                            return 1; // a after b
                        } else if ((b.levelOp > 2) && (a.levelOp <= 2)) {
                            return -1; // a before b
                        } */

                        const time = a.timeData - b.timeData;
                        if ((a.timeData !== 0) && (b.timeData !== 0) && (time !== 0)) { // time is different
                            return time;
                        }
                        return pos;
                    });
                    const postrules = $('#node-input-rule-container').editableList('items');
                    postrules.each(function(i) {
                        $(this).find('.node-input-rule-index').html(i+1);
                        const data = $(this).data('data');
                        data.index = i;
                    });
                });
                // #endregion Button
                // #endregion rules
                // #region sun
                $('#node-input-sunControlMode').on('change focus focusin focusout', (_type, _value) => {
                    const val= Number($('#node-input-sunControlMode').val());
                    if (val === 2) {
                        $('.form-row-sunControlActive').show();
                        $('.form-row-sunControlRestriction').show();
                        $('.form-row-sunControlMaximization').hide();
                    } else if (val === 1) {
                        $('.form-row-sunControlActive').show();
                        $('.form-row-sunControlRestriction').hide();
                        $('.form-row-sunControlMaximization').show();
                    } else {
                        $('.form-row-sunControlActive').hide();
                        $('.form-row-sunControlRestriction').hide();
                        $('.form-row-sunControlMaximization').hide();
                        $('.row-oversteerThreshold').hide();
                        $('.row-oversteerBlindPos').hide();
                        $('.row-oversteer2Value').hide();
                        $('.row-oversteer2Threshold').hide();
                        $('.row-oversteer2BlindPos').hide();
                        $('.row-oversteer3Value').hide();
                        $('.row-oversteer3Threshold').hide();
                        $('.row-oversteer3BlindPos').hide();
                    }
                    $('#node-input-oversteerValue').change();
                });
                // blindPosMin "undefined", "", blindPosMax "levelFixed", ""
                // console.log(`blindPosMin "${node.blindPosMinType}", "${node.blindPosMin}", blindPosMax "${node.blindPosMaxType}", "${node.blindPosMax}"`);
                setupTInput(node, {
                    typeProp: 'blindPosMinType',
                    valueProp: 'blindPosMin',
                    width: 'calc(100% - 120px)',
                    defaultType: types.LevelFix.value,
                    defaultValue: getDefLevel(node.blindPosMinType, node.blindPosMin, 'closed (min)'),
                    types: [types.LevelFix, types.LevelEntered, 'env']
                });
                setupTInput(node, {
                    typeProp: 'blindPosMaxType',
                    valueProp: 'blindPosMax',
                    width: 'calc(100% - 120px)',
                    defaultType: types.LevelFix.value,
                    defaultValue: getDefLevel(node.blindPosMaxType, node.blindPosMax, 'open (max)'),
                    types: [types.LevelFix, types.LevelEntered, 'env']
                });

                setMultiplier(node, 'smoothTime', v => {
                    const n = parseFloat(v);
                    return (v === '') || (RED.validators.number(v) && (n >= -2147483647) && (n < 0x7FFFFFFF));
                }, 60000);
                // #endregion sun
                // #region oversteering
                // #region oversteer - 1
                setupTInput(node, {
                    typeProp: 'oversteerValueType',
                    valueProp: 'oversteerValue',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon],
                    onChange(_type, _value) {
                        const sunControlMode = Number($('#node-input-sunControlMode').val());
                        const oversteerValueType = $('#node-input-oversteerValue').typedInput('type');
                        if ((oversteerValueType === types.Undefined.value) || (sunControlMode <= 0)) {
                            $('.row-oversteerBlindPos').hide();
                            $('#node-input-oversteerCompare').hide();
                            $('.row-oversteerThreshold').hide();
                            $('#node-input-oversteerValue').typedInput('width','calc(100% - 110px)');
                        } else if (oversteerValueType === 'jsonata' || oversteerValueType === types.PhaseMoon.value) {
                            $('.row-oversteerBlindPos').show();
                            $('#node-input-oversteerCompare').show();
                            $('#node-input-oversteerCompare').attr('disabled', true);
                            $('#node-input-oversteerCompare').val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('.row-oversteerThreshold').hide();
                            $('#node-input-oversteerValue').typedInput('width','calc(100% - 220px)');
                        } else {
                            $('.row-oversteerBlindPos').show();
                            $('#node-input-oversteerCompare').show();
                            $('#node-input-oversteerCompare').attr('disabled', false);
                            $('#node-input-oversteerValue').typedInput('width','calc(100% - 220px)');
                            const condOp = $('#node-input-oversteerCompare').val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('.row-oversteerThreshold').show(); // condOpB
                            } else {
                                $('.row-oversteerThreshold').hide(); // condOpB
                            }
                        }
                        $('#node-input-oversteerThreshold').change();
                        $('#node-input-oversteerBlindPos').change();
                        $('#node-input-oversteer2Value').change();
                    }
                });

                const $oversteerCompare = $('#node-input-oversteerCompare');
                appendOptions(node, $oversteerCompare, 'comparator');
                $oversteerCompare.val(node.oversteerCompare || 'gte');
                $oversteerCompare.change(() => { $('#node-input-oversteerValue').change(); });
                setupTInput(node, {
                    typeProp: 'oversteerThresholdType',
                    valueProp: 'oversteerThreshold',
                    width: 'calc(100% - 120px)',
                    defaultType: 'num',
                    defaultValue: '',
                    types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                });
                setupTInput(node, {
                    typeProp: 'oversteerBlindPosType',
                    valueProp: 'oversteerBlindPos',
                    width: 'calc(100% - 120px)',
                    defaultType: types.LevelFix.value,
                    defaultValue: getDefLevel(node.oversteerBlindPosType, node.oversteerBlindPos, 'open (max)'),
                    types: [types.LevelFix, types.LevelEntered, 'env']
                });
                // #endregion oversteer - 1
                // #region oversteer - 2
                setupTInput(node, {
                    typeProp: 'oversteer2ValueType',
                    valueProp: 'oversteer2Value',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon],
                    onChange(_type, _value) {
                        const sunControlMode = Number($('#node-input-sunControlMode').val());
                        const oversteer1ValueType = $('#node-input-oversteerValue').typedInput('type');
                        const oversteer2ValueType = $('#node-input-oversteer2Value').typedInput('type');

                        if ((oversteer1ValueType === types.Undefined.value) || (sunControlMode <= 0)) {
                            $('#node-input-oversteer2Value').typedInput('type', types.Undefined.value);
                            $('.row-oversteer2Value').hide();
                            $('.row-oversteer2Threshold').hide();
                            $('#node-input-oversteer2Compare').hide();
                            $('.row-oversteer2BlindPos').hide();
                        } else if (oversteer2ValueType === types.Undefined.value) {
                            $('.row-oversteer2Value').show();
                            $('.row-oversteer2BlindPos').hide();
                            $('#node-input-oversteer2Compare').hide();
                            $('.row-oversteer2Threshold').hide();
                            $('#node-input-oversteer2Value').typedInput('width', 'calc(100% - 110px)');
                        } else if (oversteer2ValueType === 'jsonata' || oversteer2ValueType === types.PhaseMoon.value) {
                            $('.row-oversteer2Value').show();
                            $('.row-oversteer2BlindPos').show();
                            $('#node-input-oversteer2Compare').show();
                            $('#node-input-oversteer2Compare').attr('disabled', true);
                            $('#node-input-oversteer2Compare').val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('.row-oversteer2Threshold').hide();
                            $('#node-input-oversteer2Value').typedInput('width', 'calc(100% - 220px)');
                        } else {
                            $('.row-oversteer2Value').show();
                            $('.row-oversteer2BlindPos').show();
                            $('#node-input-oversteer2Compare').show();
                            $('#node-input-oversteer2Compare').attr('disabled', false);
                            $('#node-input-oversteer2Value').typedInput('width', 'calc(100% - 220px)');
                            const condOp = $('#node-input-oversteer2Compare').val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('.row-oversteer2Threshold').show(); // condOpB
                            } else {
                                $('.row-oversteer2Threshold').hide(); // condOpB
                            }
                        }
                        $('#node-input-oversteer2Threshold').change();
                        $('#node-input-oversteer2BlindPos').change();
                        $('#node-input-oversteer3Value').change();
                    }
                });

                const $oversteer2Compare = $('#node-input-oversteer2Compare');
                appendOptions(node, $oversteer2Compare, 'comparator');
                $oversteer2Compare.val(node.oversteer2Compare || 'gte');
                $oversteer2Compare.change(() => { $('#node-input-oversteer2Value').change(); });
                setupTInput(node, {
                    typeProp: 'oversteer2ThresholdType',
                    valueProp: 'oversteer2Threshold',
                    width: 'calc(100% - 120px)',
                    defaultType: 'num',
                    defaultValue: '',
                    types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                });
                setupTInput(node, {
                    typeProp: 'oversteer2BlindPosType',
                    valueProp: 'oversteer2BlindPos',
                    width: 'calc(100% - 120px)',
                    defaultType: types.LevelFix.value,
                    defaultValue: getDefLevel(node.oversteer2BlindPosType, node.oversteer2BlindPos, 'open (max)'),
                    types: [types.LevelFix, types.LevelEntered, 'env']
                });
                // #endregion oversteer - 2
                // #region oversteer - 3
                setupTInput(node, {
                    typeProp: 'oversteer3ValueType',
                    valueProp: 'oversteer3Value',
                    width: 'calc(100% - 110px)',
                    defaultType: types.Undefined.value,
                    defaultValue: '',
                    types: [types.Undefined, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon],
                    onChange(_type, _value) {
                        const sunControlMode = Number($('#node-input-sunControlMode').val());
                        const oversteer2ValueType = $('#node-input-oversteer2Value').typedInput('type');
                        const oversteer3ValueType = $('#node-input-oversteer3Value').typedInput('type');

                        if ((oversteer2ValueType === types.Undefined.value) || (sunControlMode <= 0)) {
                            $('#node-input-oversteer3Value').typedInput('type', types.Undefined.value);
                            $('.row-oversteer3Value').hide();
                            $('.row-oversteer3Threshold').hide();
                            $('#node-input-oversteer3Compare').hide();
                            $('.row-oversteer3BlindPos').hide();
                        } else if (oversteer3ValueType === types.Undefined.value) {
                            $('.row-oversteer3Value').show();
                            $('.row-oversteer3BlindPos').hide();
                            $('#node-input-oversteer3Compare').hide();
                            $('.row-oversteer3Threshold').hide();
                            $('#node-input-oversteer3Value').typedInput('width', 'calc(100% - 110px)');
                        } else if (oversteer3ValueType === 'jsonata' || oversteer3ValueType === types.PhaseMoon.value) {
                            $('.row-oversteer3Value').show();
                            $('.row-oversteer3BlindPos').show();
                            $('#node-input-oversteer3Compare').show();
                            $('#node-input-oversteer3Compare').attr('disabled', true);
                            $('#node-input-oversteer3Compare').val(selFields.comparator[0].id); // only true is valid for jsonata
                            $('.row-oversteer3Threshold').hide();
                            $('#node-input-oversteer3Value').typedInput('width', 'calc(100% - 220px)');
                        } else {
                            $('.row-oversteer3Value').show();
                            $('.row-oversteer3BlindPos').show();
                            $('#node-input-oversteer3Compare').show();
                            $('#node-input-oversteer3Compare').attr('disabled', false);
                            $('#node-input-oversteer3Value').typedInput('width', 'calc(100% - 220px)');
                            const condOp = $('#node-input-oversteer3Compare').val();
                            let operatorCount = 1;
                            const fields = selFields.comparator;
                            const fieldsLength = fields.length;
                            for (let index = 0; index < fieldsLength; index++) {
                                const el = fields[index];
                                if (el.id === condOp) {
                                    operatorCount = el.operatorCount;
                                    break;
                                }
                            }
                            if (operatorCount > 1) {
                                $('.row-oversteer3Threshold').show(); // condOpB
                            } else {
                                $('.row-oversteer3Threshold').hide(); // condOpB
                            }
                        }
                        $('#node-input-oversteer3Threshold').change();
                        $('#node-input-oversteer3BlindPos').change();
                    }
                });

                const $oversteer3Compare = $('#node-input-oversteer3Compare');
                appendOptions(node, $oversteer3Compare, 'comparator');
                $oversteer3Compare.val(node.oversteer3Compare || 'gte');
                $oversteer3Compare.change(() => { $('#node-input-oversteer3Value').change(); });
                setupTInput(node, {
                    typeProp: 'oversteer3ThresholdType',
                    valueProp: 'oversteer3Threshold',
                    width: 'calc(100% - 120px)',
                    defaultType: 'num',
                    defaultValue: '',
                    types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                });
                setupTInput(node, {
                    typeProp: 'oversteer3BlindPosType',
                    valueProp: 'oversteer3BlindPos',
                    width: 'calc(100% - 120px)',
                    defaultType: types.LevelFix.value,
                    defaultValue: getDefLevel(node.oversteer3BlindPosType, node.oversteer3BlindPos, 'open (max)'),
                    types: [types.LevelFix, types.LevelEntered, 'env']
                });
                // #endregion oversteer - 3
                // #endregion oversteering
                // #region Enhanced settings
                $('.spinner-noLimit').spinner();
                $('.spinner-angle').spinner({
                    max: 360,
                    min: -360,
                    step: 1
                });
                $('.spinner-altitude').spinner({
                    max: 90,
                    min: 0,
                    step: 1
                });
                $('.spinner-level').spinner({
                    max: 100,
                    min: 0,
                    step: 0.01,
                    numberFormat: 'n'
                });
                $('.spinner-time').spinner({
                    max: 1439,
                    min: 0,
                    step: 1
                });
                // #endregion Enhanced settings
                // fill rules
                if (node.rules) {
                    for (let i = 0; i < node.rules.length; i++) {
                        const rule = node.rules[i];
                        // rule.index = i;
                        $('#node-input-rule-container').editableList('addItem', rule);
                    }
                    setTimeout(() => {
                        $('#node-input-sunControlMode').change();
                        const postrules = $('#node-input-rule-container').editableList('items');
                        postrules.each(function (_i) {
                            resizeRule($(this));
                        });
                        resizeContainer();
                    }, 1500);
                }

                // #region dialog
                const $dialog = $('#dialog-edit-rule').dialog({
                    title: node._('blind-control.label.dialogtitle'),
                    autoOpen: false,
                    resizable: true,
                    height: Math.min(900, $(window).height() * 0.8),
                    width: Math.min(850, $(window).width() * 0.8),
                    modal: true,
                    closeOnEscape: true,
                    buttons: {
                        Ok() {
                            _dialogSaveData();
                            $dialog.dialog( 'close' );
                        },
                        Cancel() {
                            $dialog.dialog( 'close' );
                        }
                    }
                });

                const $dialogName = $dialog.find('#dlg-ip-blindctl-rule-name');
                let $dialogData = null;
                let dialogDataIndex = -1;
                /**
                 * Build the dialog
                 */
                const $dialogCondAOperand = $dialog.find('#dlg-ip-blindctl-rule-condAOperand');
                console.log('init 1 ',$dialogCondAOperand,$dialogCondAOperand.typedInput( 'instance' ));
                $dialogCondAOperand.typedInput({
                    default: types.Unlimited.value,
                    types: [types.Unlimited, 'msg', 'flow', 'global', 'env', 'jsonata', types.PhaseMoon]
                });
                $dialogCondAOperand.typedInput('width', '40%'); // calc(100% - 220px)

                const $dialogCondOperator = $dialog.find('#dlg-ip-blindctl-rule-condAOperator');
                appendOptions(node, $dialogCondOperator, 'comparator');
                const $dialogCondBOperand = $dialog.find('#dlg-ip-blindctl-rule-condBOperand');
                /* if ($dialogCondBOperand.typedInput( 'instance' ) !== undefined) {
                    $dialogCondBOperand.typedInput('destroy').remove();
                } */
                $dialogCondBOperand.typedInput({
                    default: 'num',
                    types: ['num', 'str', 'bool', 'flow', 'global', 'env']
                });
                $dialogCondBOperand.typedInput('width', '70%');

                const $dialogTimeAOperator = $dialog.find('#dlg-ip-blindctl-rule-timeA-operator');
                $dialogTimeAOperator.append($('<option></option>').val(0).text(node._('blind-control.label.ruleTimeUntil')));
                $dialogTimeAOperator.append($('<option></option>').val(1).text(node._('blind-control.label.ruleTimeFrom')));

                const $dialogTimeAInput = $dialog.find('#dlg-ip-blindctl-rule-timeA');
                /* if ($dialogTimeAInput.typedInput( 'instance' ) !== undefined) {
                    $dialogTimeAInput.typedInput('destroy');
                } */
                $dialogTimeAInput.typedInput({
                    default: types.Undefined,
                    types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata']
                });
                $dialogTimeAInput.typedInput('width', '40%');

                const $dialogTimeAOffset = $dialog.find('#dlg-ip-blindctl-rule-offset-timeA');
                $dialogTimeAOffset.typedInput({
                    default: (types.Undefined.value),
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata']
                }).change(() => { $dialogTimeAInput.change(); });
                $dialogTimeAOffset.typedInput('width', '40%');

                const $dialogTimeAMultiplier = $dialog.find('#dlg-ip-blindctl-rule-multiplier-timeA');
                appendOptions(node, $dialogTimeAMultiplier, 'multiplier', data => (data.id > 0));

                const $dialogTimeBOperator = $dialog.find('#dlg-ip-blindctl-rule-timeB-operator');
                $dialogTimeBOperator.append($('<option></option>').val(1).text(node._('blind-control.label.ruleTimeLatest')));
                $dialogTimeBOperator.append($('<option></option>').val(0).text(node._('blind-control.label.ruleTimeEarliest')));

                const $dialogTimeBInput = $dialog.find('#dlg-ip-blindctl-rule-timeB');
                /* if ($dialogTimeBInput.typedInput('instance') !== undefined) {
                    $dialogTimeBInput.typedInput('destroy');
                } */
                $dialogTimeBInput.typedInput({
                    default: types.Undefined,
                    types: [types.Undefined, types.TimeEntered, types.TimeSun, types.TimeMoon, 'msg', 'flow', 'global', 'env', 'jsonata']
                });
                $dialogTimeBInput.typedInput('width', '40%');

                const $dialogTimeBOffset = $dialog.find('#dlg-ip-blindctl-rule-offset-timeB');
                $dialogTimeBOffset.typedInput({
                    default: (types.Undefined.value),
                    types: [types.Undefined, 'num', 'msg', 'flow', 'global', 'env', 'jsonata']
                }).change(() => { $dialogTimeBInput.change(); });
                $dialogTimeBOffset.typedInput('width', '40%');

                const $dialogTimeBMultiplier = $dialog.find('#dlg-ip-blindctl-rule-multiplier-timeB');
                appendOptions(node, $dialogTimeBMultiplier, 'multiplier', data => (data.id > 0));

                const $dialogLevel = $dialog.find('#dlg-ip-blindctl-rule-level');
                $dialogLevel.typedInput({
                    default: types.LevelFix.value,
                    types: [types.LevelFix, types.LevelEntered, 'msg', 'flow', 'global', 'env']
                });
                $dialogLevel.typedInput('width', '40%');

                const $dialogLevelOperator = $dialog.find('#dlg-ip-blindctl-rule-level-operator');
                $dialogLevelOperator.append($('<option></option>').val(0).text(node._('blind-control.label.ruleLevelAbs')));
                $dialogLevelOperator.append($('<option></option>').val(1).text(node._('blind-control.label.ruleLevelMin')));
                $dialogLevelOperator.append($('<option></option>').val(2).text(node._('blind-control.label.ruleLevelMax')));
                $dialogLevelOperator.append($('<option></option>').val(3).text(node._('blind-control.label.ruleLevelResetMin')));
                $dialogLevelOperator.append($('<option></option>').val(4).text(node._('blind-control.label.ruleLevelResetMax')));

                $dialogTimeAInput.change(() => {
                    const opType = $dialogTimeAInput.typedInput('type');
                    if (opType === types.Undefined.value) {
                        $dialogTimeAOperator.hide();
                        $('#dialog-row-offset-timeA').hide();
                    } else if (opType === types.TimeSun.value || opType === types.TimeMoon.value) {
                        $dialogTimeAOperator.show();
                        $('#dialog-row-offset-timeA').show();
                    } else {
                        $dialogTimeAOperator.show();
                        $('#dialog-row-offset-timeA').hide();
                    }
                    getBackendData(d => {
                        if (d.value && d.value !== 'none') {
                            const dv = new Date(d.value);
                            $('#dialog-row-time').attr('title', bdDateToTime(dv));
                            $dialogTimeAInput.attr('timedata', dv.getTime());
                        } else {
                            $('#dialog-row-time').attr('title', d.value);
                            $dialogTimeAInput.attr('timedata', '0');
                        }
                    }, {
                        kind: 'getTimeData',
                        config : $nodeConfig.val(),
                        type: opType,
                        value: $dialogTimeAInput.typedInput('value'),
                        offsetType: $dialogTimeAOffset.typedInput('type'),
                        offset: $dialogTimeAOffset.typedInput('value'),
                        multiplier: $dialogTimeAMultiplier.val()
                    });
                    $dialogTimeBInput.change();
                });

                $dialogTimeBInput.change(() => {
                    const opAType = $dialogTimeAInput.typedInput('type');
                    if (opAType === types.Undefined.value) {
                        $dialogTimeBInput.typedInput('type', types.Undefined.value);
                        $('#dialog-row-offset-timeB').hide();
                    } else {
                        const opType = $dialogTimeBInput.typedInput('type');
                        if (opType === types.Undefined.value) {
                            $dialogTimeBOperator.hide();
                            $('#dialog-row-offset-timeB').hide();
                        } else if (opType === types.TimeSun.value || opType === types.TimeMoon.value) {
                            $dialogTimeBOperator.show();
                            $('#dialog-row-offset-timeB').show();
                        } else {
                            $dialogTimeBOperator.show();
                            $('#dialog-row-offset-timeB').hide();
                        }
                        getBackendData(d => {
                            if (d.value && d.value !== 'none') {
                                const dv = new Date(d.value);
                                $('#dialog-row-time').attr('title', bdDateToTime(dv));
                                $dialogTimeBInput.attr('timedata', dv.getTime());
                            } else {
                                $('#dialog-row-time').attr('title', d.value);
                                $dialogTimeBInput.attr('timedata', '0');
                            }
                        }, {
                            kind: 'getTimeData',
                            config: $nodeConfig.val(),
                            type: opType,
                            value: $dialogTimeBInput.typedInput('value'),
                            offsetType: $dialogTimeBOffset.typedInput('type'),
                            offset: $dialogTimeBOffset.typedInput('value'),
                            multiplier: $dialogTimeBMultiplier.val()
                        });
                    }
                });

                $dialogCondAOperand.change(() => {
                    const propType = $dialogCondAOperand.typedInput('type');
                    if (propType === 'none') {
                        $dialogCondOperator.val(selFields.comparator[0].id);
                        $dialogCondOperator.hide();
                        $('#dialog-row-condB').hide();
                    } else if (propType === 'jsonata' || propType === types.PhaseMoon.value) {
                        $dialogCondOperator.show();
                        $dialogCondOperator.attr('disabled', true);
                        $dialogCondOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                        $('#dialog-row-condB').hide();
                    } else {
                        $dialogCondOperator.show();
                        $dialogCondOperator.attr('disabled', false);
                        const condOp = $dialogCondOperator.val();
                        let operatorCount = 1;
                        const fields = selFields.comparator;
                        const fieldsLength = fields.length;
                        for (let index = 0; index < fieldsLength; index++) {
                            const el = fields[index];
                            if (el.id === condOp) {
                                operatorCount = el.operatorCount;
                                break;
                            }
                        }
                        if (operatorCount > 1) {
                            $('#dialog-row-condB').show();
                        } else {
                            $('#dialog-row-condB').hide();
                        }

                    }
                    $dialogCondBOperand.change();
                });
                $dialogCondOperator.change(() => { $dialogCondAOperand.change(); });

                /**
                 * load the data from the rule
                 */
                function _dialogLoadData(containerIndex, containerRow) {
                    $dialogData = containerRow;
                    dialogDataIndex = containerIndex;
                    const data = JSON.parse($dialogData.data('ruleData'));
                    console.log('_dialogLoadData',data);
                    $dialogName.val(data.name);
                    $dialogCondOperator.val(data.validOperator || selFields.comparator[0].id);
                    console.log('_dialogLoadData dialogCondAOperand');
                    $dialogCondAOperand.typedInput('type',data.validOperandAType);
                    $dialogCondAOperand.typedInput('value',data.validOperandAValue);
                    console.log('_dialogLoadData dialogCondBOperand');
                    $dialogCondBOperand.typedInput('type',data.validOperandBType);
                    $dialogCondBOperand.typedInput('value',data.validOperandBValue);
                    console.log('_dialogLoadData dialogTimeAOperator');
                    $dialogTimeAOperator.val(data.timeOp || 0);
                    console.log('_dialogLoadData dialogTimeAInput', data.timeType, data.timeValue);
                    $dialogTimeAInput.typedInput('type',data.timeType);
                    $dialogTimeAInput.typedInput('value',data.timeValue);
                    console.log('_dialogLoadData dialogTimeAOffset');
                    $dialogTimeAOffset.typedInput('type',data.offsetType);
                    $dialogTimeAOffset.typedInput('value',data.offsetValue);
                    console.log('_dialogLoadData dialogTimeAMultiplier');
                    $dialogTimeAMultiplier.val(data.multiplier || 60000);
                    console.log('_dialogLoadData dialogTimeBOperator');
                    $dialogTimeBOperator.val(data.timeBOp || 0);
                    console.log('_dialogLoadData dialogTimeBInput');
                    $dialogTimeBInput.typedInput('type', data.timeBType);
                    $dialogTimeBInput.typedInput('value', data.timeBValue);
                    console.log('_dialogLoadData dialogTimeBOffset');
                    $dialogTimeBOffset.typedInput('type', data.offsetBType);
                    $dialogTimeBOffset.typedInput('value', data.offsetBValue);
                    console.log('_dialogLoadData dialogTimeBMultiplier');
                    $dialogTimeBMultiplier.val(data.multiplierB || 60000);
                    console.log('_dialogLoadData dialogLevel');
                    $dialogLevel.typedInput('type',data.levelType);
                    $dialogLevel.typedInput('value',data.levelValue);
                    console.log('_dialogLoadData dialogLevelOperator');
                    $dialogLevelOperator.val(data.levelOp || 0);
                    $dialogCondAOperand.change();
                    console.log('_dialogLoadData dialogTimeAInput change');
                    $dialogTimeAInput.change();
                    $dialogTimeBInput.change();
                    console.log('_dialogLoadData ende');
                    $dialog.dialog('open');
                }

                /**
                 * save the data of the rule back
                 */
                function _dialogSaveData() {
                    const data = {
                        index: dialogDataIndex,
                        name:$dialogName.val(),
                        timeValue: $dialogTimeAInput.typedInput('value'),
                        timeType: $dialogTimeAInput.typedInput('type'),
                        timeOp: $dialogTimeAOperator.val(),
                        timeOpText: $dialogTimeAOperator.find('option:selected').text(),
                        offsetValue: $dialogTimeAOffset.typedInput('value'),
                        offsetType: $dialogTimeAOffset.typedInput('type'),
                        multiplier:  $dialogTimeAMultiplier.val(),
                        timeBValue: $dialogTimeBInput.typedInput('value'),
                        timeBType: $dialogTimeBInput.typedInput('type'),
                        timeBOp: $dialogTimeBOperator.val(),
                        timeBOpText: $dialogTimeBOperator.find('option:selected').text(),
                        offsetBValue: $dialogTimeBOffset.typedInput('value'),
                        offsetBType: $dialogTimeBOffset.typedInput('type'),
                        multiplierB: $dialogTimeBMultiplier.val(),
                        levelValue: $dialogLevel.typedInput('value'),
                        levelType: $dialogLevel.typedInput('type'),
                        levelOp: $dialogLevelOperator.val(),
                        levelOpText: $dialogLevelOperator.find('option:selected').text(),
                        validOperandAValue: $dialogCondAOperand.typedInput('value'),
                        validOperandAType: $dialogCondAOperand.typedInput('type'),
                        validOperator: $dialogCondOperator.val(),
                        validOperatorText: $dialogCondOperator.find('option:selected').text(),
                        validOperandBValue: $dialogCondBOperand.typedInput('value'),
                        validOperandBType: $dialogCondBOperand.typedInput('type')
                    };
                    data.description = getRuleDescription(node, selFields, data);
                    $dialogData.data('ruleData', JSON.stringify(data));
                    $('#rule-name-'+dialogDataIndex).text(data.name);
                    $('#rule-description-'+dialogDataIndex).html(data.description);
                    resizeContainer();
                }
            // #endregion dialog
            }; // setup
            $.getScript('sun-position/js/htmlglobal.js')
                .done((_data, _textStatus,  _bmvfj) => {
                    try {
                        setup(node);
                    } catch (err) {
                        console.log("failed to setup editor"); // eslint-disable-line
                        console.log(err); // eslint-disable-line
                        console.log(err.stack); // eslint-disable-line
                    }
                })
                .fail((jqxhr, settings, exception) => {
                    console.log("failed to load htmlglobal.js"); // eslint-disable-line
                    console.log(exception); // eslint-disable-line
                    console.log(exception.stack); // eslint-disable-line
                });
        },
        oneditsave() {
            const node = this;
            node.rules = saveRules($('#node-input-rule-container').editableList('items'));

            const overwriteExpire = parseFloat($('#time-control-overwriteExpire').val());
            if (isNaN(overwriteExpire) || overwriteExpire === '' || overwriteExpire === 0) {
                $('#node-input-overwriteExpire').val('');
            } else {
                let val = overwriteExpire * parseFloat($('#time-control-overwriteExpire-multiplier').val());
                if (val < 1000) {
                    val = 1000;
                }
                $('#node-input-overwriteExpire').val(val);
            }

            const smoothTime = parseFloat($('#time-control-smoothTime').val());
            if (isNaN(smoothTime) || smoothTime === '' || smoothTime === 0) {
                $('#node-input-smoothTime').val('');
            } else {
                $('#node-input-smoothTime').val(smoothTime * parseFloat($('#time-control-smoothTime-multiplier').val()));
            }
            $('#dialog-edit-rule').dialog('destroy').remove();
        },
        oneditcancel() {
            $('#dialog-edit-rule').dialog('destroy').remove();
        },
        oneditdelete() {
            $('#dialog-edit-rule').dialog('destroy').remove();
        },
        oneditresize(_size) {
            try {
                const postrules = $('#node-input-rule-container').editableList('items');
                postrules.each(function(_i) {
                    resizeRule($(this));
                });
            } catch (err) {
                console.debug(err); // eslint-disable-line no-console
            }
        }
    });</script>

<script type="text/html" data-template-name="blind-control">
    <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
        <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
        <input type="text" class="row-full-width" id="node-input-positionConfig">
    </div>
    <hr>
    <!-- blind ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
        <label><i class="fa fa-window-maximize"></i> <span data-i18n="[html]blind-control.text.blind" class="row-full-width"></span></span></label>
    </div>
    <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindIncrement">
        <label for="node-input-blindIncrement"><i class="fa fa-plus-circle"></i> <span data-i18n="blind-control.label.blindIncrement"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-blindIncrement" data-i18n="[placeholder]blind-control.placeholder.blindIncrement"/>
    </div>
    <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindOpenPos">
        <label for="node-input-blindOpenPos"><i class="fa fa-chevron-circle-up"></i> <span data-i18n="blind-control.label.blindOpenPos"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-blindOpenPos" data-i18n="[placeholder]blind-control.placeholder.blindOpenPos"/>
    </div>
    <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindClosedPos">
        <label for="node-input-blindClosedPos"><i class="fa fa-chevron-circle-down"></i> <span data-i18n="blind-control.label.blindClosedPos"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-blindClosedPos" data-i18n="[placeholder]blind-control.placeholder.blindClosedPos"/>
    </div>
    <hr>
    <!-- time ######################################################################## -->
    <div class="is-to-show-initially">
        <label><i class="fa fa-list"></i> <span data-i18n="[html]blind-control.text.time"></span></span></label>
        <div class="form-row node-input-rule-container-row row-full-width">
            <ol id="node-input-rule-container"></ol>
            <button type="button" id="node-button-add" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.btnAdd"></span></button> &nbsp;
            <button type="button" id="node-button-clear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="blind-control.label.btnClear"></span></button> &nbsp;
            <button type="button" id="node-button-sort" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnSort" style="margin-top: 4px;"><i class="fa fa-sort-amount-asc"></i> <span data-i18n="blind-control.label.btnSort"></span></button>
        </div>
    </div>

    <div class="form-row block-noindent is-to-show-initially">
        <span data-i18n="[html]blind-control.text.blindLevelDefault" class="row-full-width"></span>
    </div>
    <div class="form-row block-noindent is-to-show-initially" data-i18n="[title]blind-control.placeholder.blindLevelDefault">
        <label for="node-input-blindPosDefault"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelDefault"></span></label>
        <input type="text" id="node-input-blindPosDefault" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelDefault"/>
        <input type="hidden" id="node-input-blindPosDefaultType">
    </div>
    <hr>
    <!-- overwrite blind ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
        <label><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]blind-control.text.overwrite" class="row-full-width"></span></span></label>
    </div>
    <div class="form-row row-overwriteValue block-indent1" data-i18n="[titel]blind-control.placeholder.overwriteExpire">
        <label for="time-control-overwriteExpire"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.overwriteExpire"></span></label>
        <input type="text" class="spinner-time" id="time-control-overwriteExpire" data-i18n="[placeholder]blind-control.placeholder.overwriteExpire" value=""/>
        <select id="time-control-overwriteExpire-multiplier" class="node-input-multiplier">
            <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
            <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
            <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
        </select>
        <input type="hidden" id="node-input-overwriteExpire">
    </div>
    <hr>
    <!-- sun ######################################################################## -->
    <div class="form-row block-noindent is-to-show-initially">
            <label><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]blind-control.text.overwrite" class="row-full-width"></span></span></label>
            <span data-i18n="[html]blind-control.text.sunControlMode" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row block-noindent" ata-i18n="[title]blind-control.placeholder.sunControlMode">
        <label for="node-input-sunControlMode"><i class="fa fa-play-circle"></i> <span data-i18n="blind-control.label.sunControlMode"></span></label>
        <select id="node-input-sunControlMode" class="row-full-width">
            <option value="0" data-i18n="[html]blind-control.label.sunControlOff"></option>
            <option value="1" data-i18n="[html]blind-control.label.sunControlMaximize"></option>
            <option value="2" data-i18n="[html]blind-control.label.sunControlRestrict"></option>
        </select>
    </div>
    <div class="form-row form-row-sunControlRestriction block-noindent">
        <span data-i18n="[html]blind-control.text.sunControlRestriction" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlMaximization block-noindent">
        <span data-i18n="[html]blind-control.text.sunControlMaximization" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <hr class="form-row-sunControlActive" >
    <!-- window ######################################################################## -->
    <div class="form-row form-row-sunControlActive block-noindent">
        <span data-i18n="[html]blind-control.text.windowAzimuth" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowAzimuthStart">
        <label for="node-input-windowAzimuthStart"><i class="fa fa-compass fa-spin"></i> <span data-i18n="blind-control.label.windowAzimuthStart"></span></label>
        <input type="text" class="spinner-angle row-full-width" id="node-input-windowAzimuthStart" data-i18n="[placeholder]blind-control.placeholder.windowAzimuthStart"/>
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowAzimuthEnd">
        <label for="node-input-windowAzimuthEnd"><i class="fa fa-compass fa-spin"></i> <span data-i18n="blind-control.label.windowAzimuthEnd"></span></label>
        <input type="text" class="spinner-angle row-full-width" id="node-input-windowAzimuthEnd" data-i18n="[placeholder]blind-control.placeholder.windowAzimuthEnd"/>
    </div>
    <div class="form-row form-row-sunControlRestriction block-noindent">
        <span data-i18n="[html]blind-control.text.windowPos" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowTop">
        <label for="node-input-windowTop"><i class="fa fa-arrow-up"></i> <span data-i18n="blind-control.label.windowTop"></span></label>
        <input type="text" class="spinner-noLimit row-full-width" id="node-input-windowTop" data-i18n="[placeholder]blind-control.placeholder.windowTop"/>
    </div>
    <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowBottom">
        <label for="node-input-windowBottom"><i class="fa fa-arrow-down"></i> <span data-i18n="blind-control.label.windowBottom"></span></label>
        <input type="text" class="spinner-noLimit row-full-width" id="node-input-windowBottom" data-i18n="[placeholder]blind-control.placeholder.windowBottom"/>
    </div>
     <!-- sun ######################################################################## -->
     <div class="form-row form-row-sunControlRestriction block-indent1-noadd">
        <span data-i18n="[html]blind-control.text.sunCtrlLoF" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunFloorLength">
        <label for="node-input-sunFloorLength"><i class="fa fa-arrows-h"></i> <span data-i18n="blind-control.label.sunFloorLength"></span></label>
        <input type="text" class="spinner-noLimit row-full-width" id="node-input-sunFloorLength" data-i18n="[placeholder]blind-control.placeholder.sunFloorLength"/>
    </div>
    <div class="form-row form-row-sunControlRestriction block-indent1-noadd">
        <span data-i18n="[html]blind-control.text.sunCtrlRestrict" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunMinAltitude">
        <label for="node-input-sunMinAltitude"><i class="fa fa-arrows-v"></i> <span data-i18n="blind-control.label.sunMinAltitude"></span></label>
        <input type="text" class="spinner-altitude row-full-width" id="node-input-sunMinAltitude" data-i18n="[placeholder]blind-control.placeholder.sunMinAltitude"/>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunMinDelta">
        <label for="node-input-sunMinDelta"><i class="fa fa-star-half"></i> <span data-i18n="blind-control.label.sunMinDelta"></span></label>
        <input type="text" class="spinner-level row-full-width" id="node-input-sunMinDelta" data-i18n="[placeholder]blind-control.placeholder.sunMinDelta"/>
    </div>
    <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.smoothTime">
        <label for="time-control-smoothTime"><i class="fa fa-calculator"></i> <span data-i18n="blind-control.label.smoothTime"></span></label>
        <input type="text" class="spinner-time" id="time-control-smoothTime" data-i18n="[placeholder]blind-control.placeholder.smoothTime" value=""/>
        <select id="time-control-smoothTime-multiplier" class="node-input-multiplier">
            <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
            <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
            <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
        </select>
        <input type="hidden" id="node-input-smoothTime">
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindLevelMin">
        <label for="node-input-blindPosMin"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelMin"></span></label>
        <input type="text" id="node-input-blindPosMin" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelMin"/>
        <input type="hidden" id="node-input-blindPosMinType">
    </div>
    <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindLevelMax">
        <label for="node-input-blindPosMax"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelMax"></span></label>
        <input type="text" id="node-input-blindPosMax" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelMax"/>
        <input type="hidden" id="node-input-blindPosMaxType">
    </div>
    <hr class="form-row-sunControlActive" >
    <!-- oversteering ######################################################################## -->
    <div class="form-row form-row-sunControlActive block-noindent">
        <span data-i18n="[html]blind-control.text.oversteer" class="row-full-width" style="word-wrap:break-word;"></span>
    </div>
    <div class="form-row form-row-sunControlActive block-noindent" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteerValue"> <i class="fa fa-thermometer-three-quarters fa-fw"></i> </i> <span data-i18n="blind-control.label.oversteerValue"></span></label>
        <input type="text" id="node-input-oversteerValue" class="" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteerValueType">
        <select id="node-input-oversteerCompare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row row-oversteerThreshold is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.oversteerThreshold">
        <label for="node-input-oversteerThreshold"><i class="fa fa-compress"></i> <span data-i18n="blind-control.label.oversteerThreshold"></span></label>
        <input type="text" id="node-input-oversteerThreshold" data-i18n="[placeholder]blind-control.placeholder.oversteerThreshold"/>
        <input type="hidden" id="node-input-oversteerThresholdType">
    </div>
    <div class="form-row row-oversteerBlindPos is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteerBlindPos"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.oversteerBlindPos"></span></label>
        <input type="text" id="node-input-oversteerBlindPos" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteerBlindPosType">
    </div>
    <div class="form-row row-oversteer2Value is-initial-hidden block-noindent" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer2Value"> <i class="fa fa-cloud fa-fw"></i> <span data-i18n="blind-control.label.oversteer2Value"></span></label>
        <input type="text" id="node-input-oversteer2Value" class="" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer2ValueType">
        <select id="node-input-oversteer2Compare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row row-oversteer2Threshold is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.oversteerThreshold">
        <label for="node-input-oversteer2Threshold"><i class="fa fa-compress"></i> <span data-i18n="blind-control.label.oversteer2Threshold"></span></label>
        <input type="text" id="node-input-oversteer2Threshold" data-i18n="[placeholder]blind-control.placeholder.oversteerThreshold"/>
        <input type="hidden" id="node-input-oversteer2ThresholdType">
    </div>
    <div class="form-row row-oversteer2BlindPos is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer2BlindPos"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.oversteer2BlindPos"></span></label>
        <input type="text" id="node-input-oversteer2BlindPos" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer2BlindPosType">
    </div>
    <div class="form-row row-oversteer3Value is-initial-hidden block-noindent" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer3Value"> <i class="fa fa-tint fa-fw"></i> <span data-i18n="blind-control.label.oversteer3Value"></span></label>
        <input type="text" id="node-input-oversteer3Value" class="" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer3ValueType">
        <select id="node-input-oversteer3Compare" class="node-input-addOn">
        </select>
    </div>
    <div class="form-row row-oversteer3Threshold is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.oversteerThreshold">
        <label for="node-input-oversteer3Threshold"><i class="fa fa-compress"></i> <span data-i18n="blind-control.label.oversteer3Threshold"></span></label>
        <input type="text" id="node-input-oversteer3Threshold" data-i18n="[placeholder]blind-control.placeholder.oversteerThreshold"/>
        <input type="hidden" id="node-input-oversteer3ThresholdType">
    </div>
    <div class="form-row row-oversteer3BlindPos is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.oversteerValue">
        <label for="node-input-oversteer3BlindPos"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.oversteer3BlindPos"></span></label>
        <input type="text" id="node-input-oversteer3BlindPos" data-i18n="[placeholder]blind-control.placeholder.oversteerValue"/>
        <input type="hidden" id="node-input-oversteer3BlindPosType">
    </div>
    <hr>
    <!-- Enhanced ######################################################################## -->
    <div class="form-row block-noindent" data-i18n="[title]blind-control.placeholder.outputs">
        <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="blind-control.label.outputs"></span></label>
        <select id="node-input-outputs" class="row-full-width">
            <option value="1" data-i18n="blind-control.label.singleOutput"></option>
            <option value="2" data-i18n="blind-control.label.splitOutput"></option>
        </select>
    </div>
    <hr>
    <!-- End ######################################################################## -->
    <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
    </div>
    <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" class="row-full-width" data-i18n="[placeholder]node-red:common.label.name"/>
    </div>
    <div class="form-tips is-to-show-initially">
        <span data-i18n="[html]blind-control.tips.sunPosControl" style="word-wrap:break-word;"></span>
    </div>

    <!-- DIALOG ######################################################################## -->
    <div id="dialog-select-context" class="red-ui-editor" title="Select Channel and Datapoint">
        <div id="config-lookup-tree"></div>
    </div>

    <div id="dialog-edit-rule" class="red-ui-editor" title="Edit Rule">
        <div class="dialog-row">
            <label for="dlg-ip-blindctl-rule-name"><i class="fa fa-tag"></i> <span data-i18n="blind-control.label.name"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-name" class="ipalone">
        </div>
        <div class="dialog-row" id="dialog-row-condA">
            <label for="dlg-ip-blindctl-rule-condAOperand"><i class="fa fa-puzzle-piece"></i> <span data-i18n="blind-control.label.ruleCondition"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-condAOperand" class="ipMain">
            <select id="dlg-ip-blindctl-rule-condAOperator" class="ipadd dlg-ip-blindctl-rule-condOperator" >
            </select>
        </div>
        <div class="dialog-row" id="dialog-row-condB">
            <label for="dlg-ip-blindctl-rule-condBOperand"><i class="fa fa-ellipsis-h"></i> <span data-i18n="blind-control.label.ruleConditionThreshold"></span></label>
            <input id="dlg-ip-blindctl-rule-condBOperand" class="ipMain" type="text" >
        </div>
        <div class="dialog-row" id="dialog-row-timeA">
            <label for="dlg-ip-blindctl-rule-timeA"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.time"></span></label>
            <select id="dlg-ip-blindctl-rule-timeA-operator" class="ipadd dlg-ip-blindctl-rule-timeA-operator" >
            </select>
            <input type="text" id="dlg-ip-blindctl-rule-timeA" class="ipMain dlg-ip-blindctl-rule-timeA" value="">
        </div>
        <div class="dialog-row" id="dialog-row-offset-timeA">
            <label for="dlg-ip-blindctl-rule-offset-timeA"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-offset-timeA"class="ipMain dlg-ip-blindctl-rule-offset-timeA" value="">
            <select  id="dlg-ip-blindctl-rule-multiplier-timeA" class="ipadd dlg-ip-blindctl-rule-multiplier-timeA" >
            </select>
        </div>
        <div class="dialog-row" id="dialog-row-timeB">
            <label for="dlg-ip-blindctl-rule-timeB"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.timeB"></span></label>
            <select id="dlg-ip-blindctl-rule-timeB-operator" class="ipadd dlg-ip-blindctl-rule-timeB-operator" >
            </select>
            <input type="text" id="dlg-ip-blindctl-rule-timeB" class="ipMain dlg-ip-blindctl-rule-timeB" value="">
        </div>
        <div class="dialog-row" id="dialog-row-offset-timeB">
            <label for="dlg-ip-blindctl-rule-offset-timeB"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset-timeB"></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-offset-timeB"class="ipMain dlg-ip-blindctl-rule-offset-timeB" value="">
            <select  id="dlg-ip-blindctl-rule-multiplier-timeB" class="ipadd dlg-ip-blindctl-rule-multiplier-timeB" >
            </select>
        </div>
        <div class="dialog-row" id="dialog-row-level">
            <label for="dlg-ip-blindctl-rule-level"><i class="fa fa-window-maximize"></i> <span data-i18n="blind-control.label.ruleBlindLevel" ></span></label>
            <input type="text" id="dlg-ip-blindctl-rule-level" class="ipMain">
            <select id="dlg-ip-blindctl-rule-level-operator" class="ipadd dlg-ip-blindctl-rule-level-operator" >
            </select>
        </div>
    </div>
</script>
<style>
    hr {
        width: 100%
    }
    .is-to-show-initially {
        display:none
    }
    .is-initial-hidden {
        display:none
    }
    .form-row-sunControlActive {
        display:none
    }
    .form-row-sunControlRestriction {
        display:none
    }
    .form-row-sunControlMaximization {
        display:none
    }
    .form-tips {
        width: 90%
    }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 100%
    }
    .block-indent1-noadd {
        float: left;
        min-height: 1px;
        margin-left: 10px;
        width: 100%
    }
    .input-error {
        border-color: #d6615f !important;
        background-color: #ffcccc !important;
    }

    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 100%
    }
    .block-indent2-noadd {
        float: left;
        min-height: 1px;
        margin-left: 20px;
        width: 100%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .block-noindent-noadd .ui-spinner {
        width : calc(100% - 110px);
    }
    .block-indent1-noadd .ui-spinner {
        width : calc(100% - 120px);
    }
    .block-indent2-noadd .ui-spinner {
        width : calc(100% - 130px);
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
    .ui-spinner input {
        border: none !important;
        width: 95% !important;
    }

    .dialog-row {
        clear: both;
        color: #555;
        margin-bottom: 10px;
    }
    .dialog-row label {
        display: inline-block;
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipalone {
        width: 75%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipMain {
        width: 50%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipadd {
        width: 25%;
        margin-bottom: 0px !important;
    }
    .blind-rule-mainblock {
        margin-right: 28px;
    }
    .blind-rule-name-span {
        /* font-weight: bolder; */
        width: 30%; /* width: 120px; */
        float: left;
    }
    .blind-rule-description-span {
        font-size: 10px;
        margin-left: 30%; /* margin-left: 122px; */
        margin-right: 5px;
    }
    .blind-rule-finalspan {
        top: 50%;
        position: absolute;
        right: 66px;
        margin-top: -9px;
    }
    .blind-rule-editBtn {
        top: 50%;
        position: absolute;
        right: 28px;
        margin-top: -9px !important;
    }
</style>