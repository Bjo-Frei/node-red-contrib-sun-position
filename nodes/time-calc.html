<script type="text/x-red" data-template-name="time-calc">
  <div class="form-row">
    <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="time-calc.label.position"></span></label>
    <input type="text" id="node-input-positionConfig">
    <input type="hidden" id="node-input-outputs"/>
  </div>
  <hr>
  <div class="form-row time-operand1">
      <label for="node-input-operand1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-calc.label.operand1"></span></label>
      <input type="text" id="node-input-operand1" style="width:70%">
      <input type="hidden" id="node-input-operand1Type">
  </div>
  <div class="form-row time-calc-row-operand1Format hidden">
      <label for="node-input-operand1Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-calc.label.operand1Format"></span></label>
      <select style="width:70%" id="node-input-operand1Formatsel">
        <option value="0" data-i18n="time-calc.label.timeparse_UNIX"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="1" data-i18n="time-calc.label.timeparse_ECMA262"></option> <!-- date as string ECMA-262 -->
        <option value="2" data-i18n="time-calc.label.timeparse_TextOther"></option> <!-- date as string ECMA-262 -->
        <option value="3" data-i18n="time-calc.label.timeparse_YYYYMMDDHHMMSS"></option>
        <option value="4" data-i18n="time-calc.label.timeparse_YYYYMMDD_HHMMSS"></option>
        <option value="5" data-i18n="time-calc.label.timeparse_ms"></option> <!-- milliseconds since execution -->
        <option value="6" data-i18n="time-calc.label.timeparse_sec"></option> <!-- seconds since execution -->
        <option value="7" data-i18n="time-calc.label.timeparse_min"></option> <!-- minutes since execution -->
        <option value="8" data-i18n="time-calc.label.timeparse_hour"></option> <!-- hour since execution -->
        <option value="99" data-i18n="time-calc.label.timeparse_other"></option> <!-- input -->
      </select>
  </div>
  <div class="form-row time-calc-row-operand1Offset hidden">
      <label for="node-input-operand1Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-calc.label.offset"></span></label>
      <input id="node-input-operand1Offset"" class="wt-offset-time" data-i18n="[placeholder]time-calc.placeholder.offset">
      <select style="width:100px" id="node-input-operand1OffsetMultiplier">
          <option value="1" data-i18n="time-calc.label.seconds"></option>
          <option value="60" data-i18n="time-calc.label.minutes"></option>
          <option value="3600" data-i18n="time-calc.label.hours"></option>
          <option value="86400" data-i18n="time-calc.label.days"></option>
          <option value="604800" data-i18n="time-calc.label.weeks"></option>
          <option value="-1" data-i18n="time-calc.label.month"></option>
          <option value="-2" data-i18n="time-calc.label.year"></option>
      </select>
  </div>
  <hr>
  <div class="form-row time-calc-row-operator">
    <label for="node-input-operator"><i class="fa fa-calculator"></i> <span data-i18n="time-calc.label.operator"></span></label>
    <select style="width:70%" id="node-input-operator">
        <option value="0" data-i18n="time-calc.label.nothing"></option>
        <option value="1" data-i18n="time-calc.label.greater"></option>
        <option value="2" data-i18n="time-calc.label.greaterOrEqual"></option>
        <option value="3" data-i18n="time-calc.label.lesser"></option>
        <option value="4" data-i18n="time-calc.label.lesserOrEqual"></option>
        <option value="5" data-i18n="time-calc.label.equal"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="6" data-i18n="time-calc.label.unequal"></option> <!-- date as string ECMA-262 -->
        <option value="7" data-i18n="time-calc.label.equalSec"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="8" data-i18n="time-calc.label.unequalSec"></option> <!-- date as string ECMA-262 -->
        <option value="9" data-i18n="time-calc.label.equalMin"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="10" data-i18n="time-calc.label.unequalMin"></option> <!-- date as string ECMA-262 -->
    </select>
  </div>
  <hr class="time-operand2 hidden">
  <div class="form-row time-operand2 time-calc-row-operand2 hidden">
      <label for="node-input-operand2"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-calc.label.operand2"></span></label>
      <input type="text" id="node-input-operand2" style="width:70%">
      <input type="hidden" id="node-input-operand2Type">
  </div>
  <div class="form-row time-calc-row-operand2Format hidden">
      <label for="node-input-operand2Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-calc.label.operand2Format"></span></label>
      <select style="width:70%" id="node-input-operand2Formatsel">
        <option value="0" data-i18n="time-calc.label.timeparse_UNIX"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="1" data-i18n="time-calc.label.timeparse_ECMA262"></option> <!-- date as string ECMA-262 -->
        <option value="2" data-i18n="time-calc.label.timeparse_TextOther"></option> <!-- date as string ECMA-262 -->
        <option value="3" data-i18n="time-calc.label.timeparse_YYYYMMDDHHMMSS"></option>
        <option value="4" data-i18n="time-calc.label.timeparse_YYYYMMDD_HHMMSS"></option>
        <option value="5" data-i18n="time-calc.label.timeparse_ms"></option> <!-- milliseconds since execution -->
        <option value="6" data-i18n="time-calc.label.timeparse_sec"></option> <!-- seconds since execution -->
        <option value="7" data-i18n="time-calc.label.timeparse_min"></option> <!-- minutes since execution -->
        <option value="8" data-i18n="time-calc.label.timeparse_hour"></option> <!-- hour since execution -->
        <option value="99" data-i18n="time-calc.label.timeparse_other"></option> <!-- input -->
      </select>
  </div>
  <div class="form-row time-calc-row-operand2Offset hidden">
      <label for="node-input-operand2Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-calc.label.offset"></span></label>
      <input id="node-input-operand2Offset"" class="wt-offset-time" data-i18n="[placeholder]time-calc.placeholder.offset">
      <select style="width:100px" id="node-input-operand2OffsetMultiplier">
        <option value="1" data-i18n="time-calc.label.seconds"></option>
        <option value="60" data-i18n="time-calc.label.minutes"></option>
        <option value="3600" data-i18n="time-calc.label.hours"></option>
        <option value="86400" data-i18n="time-calc.label.days"></option>
        <option value="604800" data-i18n="time-calc.label.weeks"></option>
        <option value="-1" data-i18n="time-calc.label.month"></option>
        <option value="-2" data-i18n="time-calc.label.year"></option>
      </select>
  </div>
  <hr class="time-calc-row-alt hidden">
  <div class="form-row time-calc-row-alt hidden">
      <label for="node-input-operand2Property"><i class="fa fa-sun-o"></i> <span data-i18n="time-calc.label.operand2Property"></span></label>
      <input type="text" id="node-input-operand2Property" style="width: 70%"/>
  </div>
  <div class="form-row time-calc-row-operand2Alt hidden">
    <label for="node-input-operand2Alt"><i class="fa fa-clock-o"></i> <span data-i18n="time-calc.label.operand2Alt"></span></label>
    <input type="text" id="node-input-operand2Alt" style="width: 70%"/>
  </div>
  <div class="form-row time-calc-row-operand2AltFormat hidden">
    <label for="node-input-operand2AltFormatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-calc.label.operand2AltFormat"></span></label>
    <select style="width:70%" id="node-input-operand2AltFormatsel">
      <option value="0" data-i18n="time-calc.label.timeparse_UNIX"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
      <option value="1" data-i18n="time-calc.label.timeparse_ECMA262"></option> <!-- date as string ECMA-262 -->
      <option value="2" data-i18n="time-calc.label.timeparse_TextOther"></option> <!-- date as string ECMA-262 -->
      <option value="3" data-i18n="time-calc.label.timeparse_YYYYMMDDHHMMSS"></option>
      <option value="4" data-i18n="time-calc.label.timeparse_YYYYMMDD_HHMMSS"></option>
      <option value="5" data-i18n="time-calc.label.timeparse_ms"></option> <!-- milliseconds since execution -->
      <option value="6" data-i18n="time-calc.label.timeparse_sec"></option> <!-- seconds since execution -->
      <option value="7" data-i18n="time-calc.label.timeparse_min"></option> <!-- minutes since execution -->
      <option value="8" data-i18n="time-calc.label.timeparse_hour"></option> <!-- hour since execution -->
      <option value="99" data-i18n="time-calc.label.timeparse_other"></option> <!-- input -->
    </select>
  </div>
  <div class="form-row time-calc-row-operand2AltOffset hidden">
      <label for="node-input-operand2AltOffset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-calc.label.operand2AltOffset"></span></label>
      <input id="node-input-operand2AltOffset"" class="wt-offset-time" data-i18n="[placeholder]time-calc.placeholder.operand2AltOffset">
      <select style="width:100px" id="node-input-operand2AltOffsetMultiplier">
        <option value="1" data-i18n="time-calc.label.seconds"></option>
        <option value="60" data-i18n="time-calc.label.minutes"></option>
        <option value="3600" data-i18n="time-calc.label.hours"></option>
        <option value="86400" data-i18n="time-calc.label.days"></option>
        <option value="604800" data-i18n="time-calc.label.weeks"></option>
        <option value="-1" data-i18n="time-calc.label.month"></option>
        <option value="-2" data-i18n="time-calc.label.year"></option>
      </select>
  </div>

  <hr class="time-calc-result">
  <div class="form-row time-result1">
      <label for="node-input-result1"><i class="fa fa-plus-square-o"></i> <span data-i18n="time-calc.label.result1"></span></label>
      <input type="text" id="node-input-result1" style="width:70%">
      <input type="hidden" id="node-input-result1Type">
  </div>
  <div class="form-row time-result1Value hidden">
      <label for="node-input-result1Value"><i class="fa fa-envelope-o"></i> <span data-i18n="time-calc.label.result1Value"></span></label>
      <input type="text" id="node-input-result1Value" style="width:70%">
      <input type="hidden" id="node-input-result1ValueType">
  </div>
  <div class="form-row time-calc-row-result1Format hidden">
      <label for="node-input-result1Formatsel"><i class="fa fa-calendar"></i> <span data-i18n="time-calc.label.result1Format"></span></label>
      <select style="width:70%" id="node-input-result1Formatsel">
        <option value="0" data-i18n="time-calc.label.timeformat_UNIX"></option> <!-- milliseconds since Jan 1, 1970 00:00 -->
        <option value="1" data-i18n="time-calc.label.timeformat_ECMA262"></option> <!-- date as string ECMA-262 -->
        <option value="2" data-i18n="time-calc.label.timeformat_local"></option>
        <option value="14" data-i18n="time-calc.label.timeformat_localLong"></option>
        <option value="3" data-i18n="time-calc.label.timeformat_localTime"></option>
        <option value="13" data-i18n="time-calc.label.timeformat_localTimeLong"></option>
        <option value="12" data-i18n="time-calc.label.timeformat_localDate"></option>
        <option value="15" data-i18n="time-calc.label.timeformat_localDateLong"></option>
        <option value="4" data-i18n="time-calc.label.timeformat_UTC"></option>
        <option value="5" data-i18n="time-calc.label.timeformat_ISO"></option>
        <option value="10" data-i18n="time-calc.label.timeformat_YYYYMMDDHHMMSS"></option>
        <option value="11" data-i18n="time-calc.label.timeformat_YYYYMMDD_HHMMSS"></option>
        <option value="6" data-i18n="time-calc.label.timeformat_ms"></option> <!-- milliseconds since execution -->
        <option value="7" data-i18n="time-calc.label.timeformat_sec"></option> <!-- seconds since execution -->
        <option value="8" data-i18n="time-calc.label.timeformat_min"></option> <!-- minutes since execution -->
        <option value="9" data-i18n="time-calc.label.timeformat_hour"></option> <!-- hour since execution -->
        <option value="16" data-i18n="time-calc.label.timeformat_weekday"></option> <!-- hour since execution -->
        <option value="17" data-i18n="time-calc.label.timeformat_weekday2"></option> <!-- hour since execution -->
        <option value="-1" data-i18n="time-calc.label.timeformat_obj"></option> <!-- as object -->
        <option value="99" data-i18n="time-calc.label.timeformat_other"></option> <!-- input -->
      </select>
  </div>
  <div class="form-row time-calc-row-result1Offset hidden">
      <label for="node-input-result1Offset"><i class="fa fa-arrows-h"></i> <span data-i18n="time-calc.label.offset"></span></label>
      <input id="node-input-result1Offset"" class="wt-offset-time" data-i18n="[placeholder]time-calc.placeholder.offset">
      <select style="width:100px" id="node-input-result1OffsetMultiplier">
        <option value="1" data-i18n="time-calc.label.seconds"></option>
        <option value="60" data-i18n="time-calc.label.minutes"></option>
        <option value="3600" data-i18n="time-calc.label.hours"></option>
        <option value="86400" data-i18n="time-calc.label.days"></option>
        <option value="604800" data-i18n="time-calc.label.weeks"></option>
        <option value="-1" data-i18n="time-calc.label.month"></option>
        <option value="-2" data-i18n="time-calc.label.year"></option>
      </select>
  </div>
  <hr>
  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="time-calc.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]time-calc.placeholder.name">
  </div>
</script>
<style>
  .time-calc-times {
    width: 90px;
  }
  #time-calc-time {
    width: 75px;
    margin-left: 8px;
    margin-bottom: 8px;
  }
  .time-calc-count {
    width: 40px !important;
  }
</style>

<script type="text/x-red" data-help-name="time-calc">
  <p>Injects a message into a flow either manually or at timestamps which can also depending on the sunset, sunrise, or moon set and rise. The message
  payload can be a variety of types, including strings, JavaScript objects, the current time or the cuttent sun or moon position.</p>
  <h3>Outputs</h3>
  <dl class="message-properties">
      <dt>payload<span class="property-type">various</span></dt>
      <dd>The configured payload of the message.</dd>
      <dt class="optional">topic <span class="property-type">string</span></dt>
      <dd>An optional property that can be configured in the node.</dd>
      <dt class="optional">time <span class="property-type">time</span></dt>
      <dd>An optional property that can be configured when the inject node should emit a message on that timestamp.</dd>
      <dt class="optional">offset <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. The offset can be a positive or negative and defines a time offset to the choosen time.</dd>
      <dt class="optional">day select <span class="property-type">number</span></dt>
      <dd>An optional property which is only available if an time is choosen. There can be defined on which days a msg should be emited.</dd>
  </dl>
  <h3>Details</h3>
  <p>The time-calc node can initiate a flow with a specific payload value.
  The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
  <p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
  <p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
  inject at specified time stamp in a daily interval which can be set directly or by using the suncalc module to generate an output at various sunrise, sunset, moonrise or moonset times based on a specified location.</p>
  <p><b>Note</b>: The next timestamp will be calculated if a timestamp is reached, settings are changed or the inject node is manual triggered. For a given timestamp (or an alternate timestamp) through a flow or global context a recalculation time could be defined. Then planned emit time then is recalculated every end of this interval. Changes to the contexts then only lead to a change of the planned emit time if a recalculation is done!</p>
  <p><b>Note</b>: To include a newline in a string you must use a Function node to create the payload.</p>

  <h3>Sun times:</h3>
  <p>
    <table>
        <thead>
        <tr>
        <th>Time</th>
        <th>Description</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><code>astronomicalDawn</code></td>
        <td>night ends (morning astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDawn</code></td>
        <td>amateur astronomical dawn (sun at 12° before sunrise)</td>
        </tr>
        <tr>
        <td><code>nauticalDawn</code></td>
        <td>nautical dawn (morning nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDawn</code></td>
        <td>dawn (morning nautical twilight ends, morning civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDawnEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>sunrise</code></td>
        <td>sunrise (top edge of the sun appears on the horizon)</td>
        </tr>
        <tr>
        <td><code>sunriseEnd</code></td>
        <td>sunrise ends (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>goldenHourEnd</code></td>
        <td>morning golden hour (soft light, best time for photography) ends</td>
        </tr>
        <tr>
        <td><code>solarNoon</code></td>
        <td>solar noon (sun is in the highest position)</td>
        </tr>
        <tr>
        <td><code>goldenHourStart</code></td>
        <td>evening golden hour starts</td>
        </tr>
        <tr>
        <td><code>sunsetStart</code></td>
        <td>sunset starts (bottom edge of the sun touches the horizon)</td>
        </tr>
        <tr>
        <td><code>sunset</code></td>
        <td>sunset (sun disappears below the horizon, evening civil twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskStart</code></td>
        <td>blue Hour start (time for special photography photos starts)</td>
        </tr>
        <tr>
        <td><code>civilDusk</code></td>
        <td>dusk (evening nautical twilight starts)</td>
        </tr>
        <tr>
        <td><code>blueHourDuskEnd</code></td>
        <td>blue Hour end (time for special photography photos end)</td>
        </tr>
        <tr>
        <td><code>nauticalDusk</code></td>
        <td>nautical dusk end (evening astronomical twilight starts)</td>
        </tr>
        <tr>
        <td><code>amateurDusk</code></td>
        <td>amateur astronomical dusk (sun at 12° after sunrise)</td>
        </tr>
        <tr>
        <td><code>astronomicalDusk</code></td>
        <td>night starts (dark enough for astronomical observations)</td>
        </tr>
        <tr>
        <td><code>nadir</code></td>
        <td>nadir (darkest moment of the night, sun is in the lowest position)</td>
        </tr>
        </tbody>
        </table>
  </p>
  <p>It can also be configured to inject once each time the flows are started.</p>
  <h3>References</h3>
  <ul>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">Node-Red</a> - the Node-Red Node overview</li>
      <li><a href="https://github.com/HM-RedMatic/node-red-contrib-sun-position">GitHub</a> - the nodes github repository</li>
      <li><a href="https://flows.nodered.org/node/node-red-contrib-sun-position">NPM</a> - the nodes npm node description</li>
  </ul>
  With friendly support by <b>agag</b>.
</script>

<script type="text/javascript">
  function clipValueLength(v, l) {
    if (v.length > l) {
      return v.substring(0, l - 3) + "...";
    }
    return v;
  }

  function getValueLabel(t, v, l) {
    l = l || 15;
    if (t === "string" || t === "str") {
      if (v == "") {
        return v;
      }
      return '"' + clipValueLength(v, l) + '"';
    } else if (t === "num" || t === "bool") {
      if (v == "") {
        return v;
      }
      return "" + v;
    } else if (t === "msg") {
      return t + "." + clipValueLength(v, l);
    } else if (t === "flow" || t === "global") {
      var result = RED.utils.parseContextKey(v);
      return t + "." + clipValueLength(result.key, l);
    } else if (t == "operand1") {
      return "input data";
    } else if (t == "pdsCalcData") {
      return "{sun position}";
    } else if (t == "pdmCalcData") {
      return "{moon position}";
    } else if (t == "pdsTime") {
      let res = v
        .replace("astronomical", "astro-")
        .replace("nautical", "naut-")
        .replace("civil", "")
        .replace("amateur", "amat-")
        .replace("blueHour", "blHr-")
        .replace("goldenHour", "goHr-");
      return clipValueLength(res, l);
    } else if (t == "pdmTime") {
      return "moon" + v;
    }
    return clipValueLength(v, l);
  }

  RED.nodes.registerType("time-calc", {
    category: "time and astro",
    color: "#FDF0C2",
    icon: "time-calc-black.png",
    inputs: 1,
    outputs: 1,
    defaults: {
      outputs: {
        value: 1
      },
      name: {
        value: "",
        required: false
      },
      positionConfig: {
        value: "",
        type: "position-config",
        required: true
      },
      //#region operand1
      operand1: {
        value: "payload",
        validate: RED.validators.typedInput("operand1Type")
      },
      operand1Type: {
        value: "msg"
      },
      operand1Format: {
        value: 0,
        required: true,
        validate: function (v) {
          return RED.validators.number()(v) || typeof v === "undefined";
        }
      },
      operand1Offset: {
        value: 0,
        required: true,
        validate: RED.validators.number()
      },
      operand1OffsetMultiplier: {
        value: 60,
        required: true,
        validate: RED.validators.number()
      },
      //#endregion operand1
      //#region operator
      operator: {
        value: 0,
        required: true,
        validate: RED.validators.number()
      },
      //#endregion operator
      //#region operand2
      operand2: {
        value: "",
        validate: function (v) {
          return (
            RED.validators.typedInput("operand2Type")(v) ||
            ($("#node-input-operand2").length ?
              $("#node-input-operand2").typedInput("type") === "none" :
              this.operand2Type === "none")
          );
        }
      },
      operand2Type: {
        value: "str"
      },
      operand2Format: {
        value: 0,
        required: true,
        validate: function (v) {
          return (
            RED.validators.number()(v) ||
            typeof v === "undefined" ||
            ($("#node-input-operand2").length ?
              $("#node-input-operand2").typedInput("type") === "none" :
              this.operand2Type === "none")
          );
        }
      },
      operand2Offset: {
        value: 0,
        required: true,
        validate: RED.validators.number()
      },
      operand2OffsetMultiplier: {
        value: 60,
        required: true,
        validate: RED.validators.number()
      },
      //#endregion operand2
      //#region operand2Alt
      operand2Property: {
        value: "",
        required: false,
        validate: function (v) {
          return (
            RED.validators.typedInput("operand2PropertyType")(v) ||
            ($("#node-input-operator").length ?
              $("#node-input-operator").val() === 0 :
              this.operator === 0) ||
            ($("#node-input-operand2").length ?
              $("#node-input-operand2").typedInput("type") === "none" :
              this.operand2Type === "none")
          );
        }
      },
      operand2PropertyType: {
        value: "none"
      },
      operand2Alt: {
        value: "",
        required: false,
        validate: function (v) {
          return (
            RED.validators.typedInput("operand2AltType")(v) ||
            ($("#node-input-operator").length ?
              $("#node-input-operator").val() === 0 :
              this.operator === 0) ||
            ($("#node-input-operand2Type").length ?
              $("#node-input-operand2").typedInput("type") === "none" :
              this.operand2Type === "none") ||
            ($("#node-input-operand2PropertyType").length ?
              $("#node-input-operand2PropertyType").typedInput("type") ===
              "none" :
              this.operand2PropertyType === "none")
          );
        }
      },
      operand2AltType: {
        value: "str"
      },
      operand2AltOffset: {
        value: 0,
        required: true,
        validate: RED.validators.number()
      },
      operand2AltOffsetMultiplier: {
        value: 60,
        required: true,
        validate: RED.validators.number()
      },
      //#endregion operand2Alt
      //#region result1
      result1: {
        value: "payload",
        validate: RED.validators.typedInput("result1Type")
      },
      result1Type: {
        value: "msg"
      },
      result1Value: {
        value: "",
        validate: function (v) {
          return (
            RED.validators.typedInput("result1ValueType")(v) ||
            $("#node-input-result1").typedInput("type") === "none" ||
            this.result1Type === undefined
          );
        }
      },
      result1ValueType: {
        value: "operand1"
      },
      result1Format: {
        value: 0,
        required: false,
        validate: function (v) {
          return (
            RED.validators.number()(v) ||
            $("#node-input-result1").typedInput("type") === "none" ||
            this.result1Type === undefined
          );
        }
      },
      result1Offset: {
        value: 0,
        required: false,
        validate: function (v) {
          return (
            RED.validators.number()(v) ||
            $("#node-input-result1").typedInput("type") === "none" ||
            this.result1Type === undefined
          );
        }
      },
      result1OffsetMultiplier: {
        value: 60,
        required: false,
        validate: RED.validators.number()
      }
      //#endregion result1
    },
    outputLabels: function () {
      if (this.outputs === 1) {
        return ["input msg after evaluation"];
      }
      return ["msg if comparision is true", "msg if comparision is false"];
    },
    label: function () {
      if (this.name) {
        return this.name;
      }
      if (this.operator > 0) {
        let op1 = getValueLabel(this.operand1Type, this.operand1);
        let op2 = getValueLabel(this.operand2Type, this.operand2);
        switch (this.operator) {
          case 1:
            return op1 + " > " + op2;
          case 2:
            return op1 + " >= " + op2;
          case 3:
            return op1 + " < " + op2;
          case 4:
            return op1 + " <= " + op2;
          case 5:
          case 7:
          case 10:
            return op1 + " == " + op2;
          case 6:
          case 8:
          case 9:
            return op1 + " != " + op2;
        }
      }
      return this._("time-calc.label.time-calc");
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    paletteLabel: "time calc",
    align: "left",
    oneditprepare: function () {
      //#region definition
      const typeUndefined = {
        value: "none",
        label: "not used",
        //icon: "icons/node-red-contrib-sun-position/inputTypeNone.png",
        hasValue: false
      };
      const typeTime = {
        value: "entered",
        label: "time of day",
        icon: "icons/node-red-contrib-sun-position/inputTypeTime.png",
        hasValue: true,
        validate: /^(0[0-9]|[0-9]|1[0-9]|2[0-3])(?::([0-5][0-9]|[0-9]))?(?::([0-5][0-9]|[0-9]))?\s*(pm?)?$/
      };
      const typeTimeSun = {
        value: "pdsTime",
        label: "sun time ",
        icon: "icons/node-red-contrib-sun-position/inputTypeSunClock.png",
        options: [
          "astronomicalDawn",
          "amateurDawn",
          "nauticalDawn",
          "blueHourDawnStart",
          "civilDawn",
          "blueHourDawnEnd",
          "sunrise",
          "sunriseEnd",
          "goldenHourEnd",
          "solarNoon",
          "goldenHourStart",
          "sunsetStart",
          "sunset",
          "blueHourDuskStart",
          "civilDusk",
          "blueHourDuskEnd",
          "amateurDusk",
          "astronomicalDusk",
          "nadir"
        ]
      };
      const typeTimeMoon = {
        value: "pdmTime",
        label: "moon time ",
        icon: "icons/node-red-contrib-sun-position/inputTypeMoonClock.png",
        options: ["rise", "set"]
      };
      const typeSunCalc = {
        value: "pdsCalcData",
        label: "sun caclucaltion",
        icon: "icons/node-red-contrib-sun-position/inputTypeSun.png",
        hasValue: false
      };
      const typeMoonCalc = {
        value: "pdmCalcData",
        label: "moon caclucaltion",
        icon: "icons/node-red-contrib-sun-position/inputTypeMoon.png",
        hasValue: false
      };
      //#endregion definition
      //#region spinner
      $(".wt-offset-time").spinner({
        max: 1439,
        min: -1439
      });

      //#endregion spinner
      //#region operand1
      $("#node-input-operand1Type").val(this.operand1Type);
      $("#node-input-operand1").typedInput({
        default: this.operand1Type || "msg",
        typeField: $("#node-input-operand1Type"),
        types: [
          "msg",
          "flow",
          "global",
          "date",
          "str",
          "num",
          typeTimeSun,
          typeTimeMoon,
          "env"
        ]
      });

      $("#node-input-operand1").on("change", function (type, value) {
        let plType = $("#node-input-operand1").typedInput("type");
        if (
          plType === typeTime.value ||
          plType === typeTimeSun.value ||
          plType === typeTimeMoon.value ||
          plType === "date"
        ) {
          $(".time-calc-row-operand1Format").hide();
          $(".time-calc-row-operand1Offset").show();
        } else if (
          plType === "msg" ||
          plType === "flow" ||
          plType === "global" ||
          plType === "str" ||
          plType === "num" ||
          plType === "env"
        ) {
          $(".time-calc-row-operand1Format").show();
          $(".time-calc-row-operand1Offset").show();
        } else {
          $(".time-calc-row-operand1Format").hide();
          $(".time-calc-row-operand1Offset").hide();
        }
        $("#node-input-operand2").change();
      });

      $('#node-input-operand1Format').attr("defValue", this._("time-inject.timeFormat.default"));
      $('#node-input-operand1Formatsel').on("change", function (type, value) {
        if (Number($('#node-input-operand1Formatsel').val()) == 99) {
          $("#node-input-operand1Format").show();
          $('#node-input-operand1Format').css({
            'width': '40%'
          });
          $('#node-input-operand1Formatsel').css({
            'width': '30%'
          });
          if (!isNaN($("#node-input-operand1Format").val())) {
            $("#node-input-operand1Format").val($('#node-input-operand1Format').attr("defValue"));
          }
        } else {
          $("#node-input-operand1Format").hide();
          $('#node-input-operand1Formatsel').css({
            'width': '70%'
          });
        }
      });
      if (isNaN(this.operand1Format)) {
        $('#node-input-operand1Formatsel').val(99);
      } else {
        $('#node-input-operand1Formatsel').val(Number(this.operand1Format));
      }
      $("#node-input-operand1Formatsel").change();
      //#endregion operand1
      $("#node-input-operator").on("change", function (type, value) {
        let val = $("#node-input-operator").val();
        if (val < 1) {
          $("#node-input-outputs").val(1);
        } else if (val > 0) {
          $("#node-input-outputs").val(2);
        }
        $("#node-input-operand2").change();
      });
      //#region operand2
      $("#node-input-operand2Type").val(this.operand2Type);
      $("#node-input-operand2").typedInput({
        default: this.operand2Type || "str",
        typeField: $("#node-input-operand2Type"),
        types: [
          "msg",
          "flow",
          "global",
          "date",
          "str",
          "num",
          typeTimeSun,
          typeTimeMoon,
          "bin",
          "env",
          "jsonata"
        ]
      });
      $("#node-input-operand2").on("change", function (type, value) {
        if ($("#node-input-operator").val() == 0) {
          $(".time-operand2").hide();
          $(".time-calc-row-operand2").hide();
          $(".time-calc-row-operand2Format").hide();
          $(".time-calc-row-operand2Offset").hide();
        } else {
          $(".time-operand2").show();
          $(".time-calc-row-operand2").show();
          let plType = $("#node-input-operand2").typedInput("type");
          if (
            plType === typeTime.value ||
            plType === typeTimeSun.value ||
            plType === typeTimeMoon.value ||
            plType === "date"
          ) {
            $(".time-calc-row-operand2Format").hide();
            $(".time-calc-row-operand2Offset").show();
          } else if (
            plType === "msg" ||
            plType === "flow" ||
            plType === "global" ||
            plType === "str" ||
            plType === "num" ||
            plType === "env"
          ) {
            $(".time-calc-row-operand2Format").show();
            $(".time-calc-row-operand2Offset").show();
          } else {
            $(".time-calc-row-operand2Format").hide();
            $(".time-calc-row-operand2Offset").hide();
          }
        }
        $("#node-input-operand2Property").change();
        $("#node-input-result1").change();
      });

      $('#node-input-operand2Format').attr("defValue", this._("time-inject.timeFormat.default"));
      $('#node-input-operand2Formatsel').on("change", function (type, value) {
        if (Number($('#node-input-operand2Formatsel').val()) == 99) {
          $("#node-input-operand2Format").show();
          $('#node-input-operand2Format').css({
            'width': '40%'
          });
          $('#node-input-operand2Formatsel').css({
            'width': '30%'
          });
          if (!isNaN($("#node-input-operand2Format").val())) {
            $("#node-input-operand2Format").val($('#node-input-operand2Format').attr("defValue"));
          }
        } else {
          $("#node-input-operand2Format").hide();
          $('#node-input-operand2Formatsel').css({
            'width': '70%'
          });
        }
      });
      if (isNaN(this.operand2Format)) {
        $('#node-input-operand2Formatsel').val(99);
      } else {
        $('#node-input-operand2Formatsel').val(Number(this.operand2Format));
      }
      $("#node-input-operand2Formatsel").change();
      //#region operand2Alt
      //#region property
      $("#node-input-operand2Property").typedInput({
        default: this.propertyType || typeUndefined.value,
        types: [typeUndefined, "flow", "global", "jsonata", "env"]
      });
      $("#node-input-operand2Property").on("change", function (type, value) {
        $("#node-input-operand2Alt").change();
      });
      //#endregion property
      $("#node-input-operand2AltType").val(this.operand2AltType);
      $("#node-input-operand2Alt").typedInput({
        default: this.operand2AltType || "str",
        typeField: $("#node-input-operand2AltType"),
        types: [
          "msg",
          "flow",
          "global",
          "date",
          "str",
          "num",
          typeTimeSun,
          typeTimeMoon,
          "bin",
          "env",
          "jsonata"
        ]
      });
      $("#node-input-operand2Alt").on("change", function (type, value) {
        let oper = $("#node-input-operator").val();
        let opType = $("#node-input-operand2").typedInput("type");
        let propType = $("#node-input-operand2Property").typedInput("type");
        if (
          opType === typeUndefined.value ||
          propType === typeUndefined.value ||
          oper == 0
        ) {
          $(".time-operand2Alt").hide();
          $(".time-inject-row-operand2Alt").hide();
          $(".time-inject-row-operand2AltOffset").hide();
          $(".time-calc-row-operand2AltFormat").hide();
        } else {
          $(".time-operand2Alt").show();
          $(".time-calc-row-operand2Alt").show();
          let plType = $("#node-input-operand2Alt").typedInput("type");
          if (
            plType === typeTime.value ||
            plType === typeTimeSun.value ||
            plType === typeTimeMoon.value ||
            plType === "date"
          ) {
            $(".time-calc-row-operand2AltFormat").hide();
            $(".time-calc-row-operand2AltOffset").show();
          } else if (
            plType === "msg" ||
            plType === "flow" ||
            plType === "global" ||
            plType === "str" ||
            plType === "num" ||
            plType === "env"
          ) {
            $(".time-calc-row-operand2AltFormat").show();
            $(".time-calc-row-operand2AltOffset").show();
          } else {
            $(".time-calc-row-operand2AltFormat").hide();
            $(".time-calc-row-operand2AltOffset").hide();
          }
        }
      });

      $('#node-input-operand2AltFormat').attr("defValue", this._("time-inject.timeFormat.default"));
      $('#node-input-operand2AltFormatsel').on("change", function (type, value) {
        if (Number($('#node-input-operand2AltFormatsel').val()) == 99) {
          $("#node-input-operand2AltFormat").show();
          $('#node-input-operand2AltFormat').css({
            'width': '40%'
          });
          $('#node-input-operand2AltFormatsel').css({
            'width': '30%'
          });
          if (!isNaN($("#node-input-operand2AltFormat").val())) {
            $("#node-input-operand2AltFormat").val($('#node-input-operand2AltFormat').attr("defValue"));
          }
        } else {
          $("#node-input-operand2AltFormat").hide();
          $('#node-input-operand2AltFormatsel').css({
            'width': '70%'
          });
        }
      });
      if (isNaN(this.operand2AltFormat)) {
        $('#node-input-operand2AltFormatsel').val(99);
      } else {
        $('#node-input-operand2AltFormatsel').val(Number(this.operand2AltFormat));
      }
      $("#node-input-operand2AltFormatsel").change();
      //#endregion operand2Alt
      //#endregion operand2
      //#region result1
      $("#node-input-result1Type").val(this.result1Type);
      $("#node-input-result1").typedInput({
        default: this.result1Type || typeUndefined.value,
        typeField: $("#node-input-result1Type"),
        types: [typeUndefined, "msg", "flow", "global"]
      });
      $("#node-input-result1ValueType").val(this.result1ValueType);
      $("#node-input-result1Value").typedInput({
        default: this.result1ValueType || "operand1",
        typeField: $("#node-input-result1ValueType"),
        types: [{
            value: "operand1",
            label: "Input value",
            hasValue: false
          },
          {
            value: "operand2",
            label: "Operand value",
            hasValue: false
          },
          "date",
          typeTime,
          typeTimeSun,
          typeTimeMoon,
          "flow",
          "global",
          "str",
          "num",
          "bool",
          "json",
          "bin",
          "env",
          "jsonata",
          typeSunCalc,
          typeMoonCalc
        ]
      });
      $("#node-input-result1").on("change", function (type, value) {
        let plType = $("#node-input-result1").typedInput("type");
        if (plType !== typeUndefined.value) {
          $(".time-result1Value").show();
          let plVType = $("#node-input-result1Value").typedInput("type");
          if (
            plType === typeTime.value ||
            plType === typeTimeSun.value ||
            plType === typeTimeMoon.value ||
            plType === "date"
          ) {
            $(".time-calc-row-result1Format").show();
            $(".time-calc-row-result1Offset").show();
          } else if (plVType === "operand1" || plVType === "operand2") {
            $(".time-calc-row-result1Format").show();
            $(".time-calc-row-result1Offset").hide();
          } else {
            $(".time-calc-row-result1Format").hide();
            $(".time-calc-row-result1Offset").hide();
          }
        } else {
          $(".time-result1Value").hide();
          $(".time-calc-row-result1Format").hide();
          $(".time-calc-row-result1Offset").hide();
        }
      });
      $("#node-input-result1Value").on("change", function (type, value) {
        $("#node-input-result1").change();
      });

      $('#node-input-result1Format').attr("defValue", this._("time-inject.timeFormat.default"));
      $('#node-input-result1Formatsel').on("change", function (type, value) {
        if (Number($('#node-input-result1Formatsel').val()) == 99) {
          $("#node-input-result1Format").show();
          $('#node-input-result1Format').css({
            'width': '40%'
          });
          $('#node-input-result1Formatsel').css({
            'width': '30%'
          });
          if (!isNaN($("#node-input-result1Format").val())) {
            $("#node-input-result1Format").val($('#node-input-result1Format').attr("defValue"));
          }
        } else {
          $("#node-input-result1Format").hide();
          $('#node-input-result1Formatsel').css({
            'width': '70%'
          });
        }
      });
      if (isNaN(this.result1Format)) {
        $('#node-input-result1Formatsel').val(99);
      } else {
        $('#node-input-result1Formatsel').val(Number(this.result1Format));
      }
      $("#node-input-result1Formatsel").change();
      //#endregion result1

      $("#node-input-time").change();
      $("#node-input-property").change();
      $("#node-input-payload").change();
      $("#node-input-operand1").change();
      $("#node-input-operator").change();
    },
    oneditsave: function () {

      if (Number($('#node-input-operand1Formatsel').val()) != 99) {
        $('#node-input-operand1Format').val($('#node-input-operand1Formatsel').val());
        this.operand1Format = $('#node-input-operand1Formatsel').val();
      }
      if (Number($('#node-input-operand2Formatsel').val()) != 99) {
        $('#node-input-operand2Format').val($('#node-input-operand2Formatsel').val());
        this.operand2Format = $('#node-input-operand2Formatsel').val();
      }
      if (Number($('#node-input-operand2AltFormatsel').val()) != 99) {
        $('#node-input-operand2AltFormat').val($('#node-input-operand2AltFormatsel').val());
        this.operand2AltFormat = $('#node-input-operand2AltFormatsel').val();
      }
      if (Number($('#node-input-result1Formatsel').val()) != 99) {
        $('#node-input-result1Format').val($('#node-input-result1Formatsel').val());
        this.result1Format = $('#node-input-result1Formatsel').val();
      }

      operand2AltFormat

      this.operand1Type = $("#node-input-operand1").typedInput("type");
      this.operand2Type = $("#node-input-operand2").typedInput("type");
      this.operand2AltType = $("#node-input-operand2Alt").typedInput("type");
      this.result1Type = $("#node-input-result1").typedInput("type");
      this.result1ValueType = $("#node-input-result1Value").typedInput("type");
      this.result2Type = $("#node-input-result2").typedInput("type");
      this.result2ValueType = $("#node-input-result2Value").typedInput("type");

      console.log($("#node-input-outputs").val());
    }
  });
</script>